var Yn=Object.defineProperty;var Xn=(t,e,r)=>e in t?Yn(t,e,{enumerable:!0,configurable:!0,writable:!0,value:r}):t[e]=r;var U=(t,e,r)=>(Xn(t,typeof e!="symbol"?e+"":e,r),r);(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))n(i);new MutationObserver(i=>{for(const s of i)if(s.type==="childList")for(const o of s.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&n(o)}).observe(document,{childList:!0,subtree:!0});function r(i){const s={};return i.integrity&&(s.integrity=i.integrity),i.referrerPolicy&&(s.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?s.credentials="include":i.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function n(i){if(i.ep)return;i.ep=!0;const s=r(i);fetch(i.href,s)}})();function Jn(t,e){return document.createElement(t,e)}function ei(t,e,r){return document.createElementNS(t,e,r)}function ti(){return ve(document.createDocumentFragment())}function ri(t){return document.createTextNode(t)}function ni(t){return document.createComment(t)}function ii(t,e,r){if(ae(t)){let n=t;for(;n&&ae(n);)n=ve(n).parent;t=n??t}ae(e)&&(e=ve(e,t)),r&&ae(r)&&(r=ve(r).firstChildNode),t.insertBefore(e,r)}function si(t,e){t.removeChild(e)}function oi(t,e){ae(e)&&(e=ve(e,t)),t.appendChild(e)}function Vr(t){if(ae(t)){for(;t&&ae(t);)t=ve(t).parent;return t??null}return t.parentNode}function ai(t){var e;if(ae(t)){const r=ve(t),n=Vr(r);if(n&&r.lastChildNode){const i=Array.from(n.childNodes),s=i.indexOf(r.lastChildNode);return(e=i[s+1])!==null&&e!==void 0?e:null}return null}return t.nextSibling}function ci(t){return t.tagName}function li(t,e){t.textContent=e}function hi(t){return t.textContent}function ui(t){return t.nodeType===1}function di(t){return t.nodeType===3}function fi(t){return t.nodeType===8}function ae(t){return t.nodeType===11}function ve(t,e){var r,n,i;const s=t;return(r=s.parent)!==null&&r!==void 0||(s.parent=e??null),(n=s.firstChildNode)!==null&&n!==void 0||(s.firstChildNode=t.firstChild),(i=s.lastChildNode)!==null&&i!==void 0||(s.lastChildNode=t.lastChild),s}const pi={createElement:Jn,createElementNS:ei,createTextNode:ri,createDocumentFragment:ti,createComment:ni,insertBefore:ii,removeChild:si,appendChild:oi,parentNode:Vr,nextSibling:ai,tagName:ci,setTextContent:li,getTextContent:hi,isElement:ui,isText:di,isComment:fi,isDocumentFragment:ae};function Ge(t,e,r,n,i){const s=e===void 0?void 0:e.key;return{sel:t,data:e,children:r,text:n,elm:i,key:s}}const ot=Array.isArray;function it(t){return typeof t=="string"||typeof t=="number"||t instanceof String||t instanceof Number}function nt(t){return t===void 0}function Q(t){return t!==void 0}const bt=Ge("",{},[],void 0,void 0);function _e(t,e){var r,n;const i=t.key===e.key,s=((r=t.data)===null||r===void 0?void 0:r.is)===((n=e.data)===null||n===void 0?void 0:n.is),o=t.sel===e.sel,a=!t.sel&&t.sel===e.sel?typeof t.text==typeof e.text:!0;return o&&i&&s&&a}function mi(){throw new Error("The document fragment is not supported on this platform.")}function gi(t,e){return t.isElement(e)}function ki(t,e){return t.isDocumentFragment(e)}function bi(t,e,r){var n;const i={};for(let s=e;s<=r;++s){const o=(n=t[s])===null||n===void 0?void 0:n.key;o!==void 0&&(i[o]=s)}return i}const wi=["create","update","remove","destroy","pre","post"];function vi(t,e,r){const n={create:[],update:[],remove:[],destroy:[],pre:[],post:[]},i=pi;for(const u of wi)for(const f of t){const k=f[u];k!==void 0&&n[u].push(k)}function s(u){const f=u.id?"#"+u.id:"",k=u.getAttribute("class"),g=k?"."+k.split(" ").join("."):"";return Ge(i.tagName(u).toLowerCase()+f+g,{},[],void 0,u)}function o(u){return Ge(void 0,{},[],void 0,u)}function a(u,f){return function(){if(--f===0){const g=i.parentNode(u);g!==null&&i.removeChild(g,u)}}}function c(u,f){var k,g,y,R;let C,S=u.data;if(S!==void 0){const b=(k=S.hook)===null||k===void 0?void 0:k.init;Q(b)&&(b(u),S=u.data)}const A=u.children,$=u.sel;if($==="!")nt(u.text)&&(u.text=""),u.elm=i.createComment(u.text);else if($==="")u.elm=i.createTextNode(u.text);else if($!==void 0){const b=$.indexOf("#"),F=$.indexOf(".",b),L=b>0?b:$.length,B=F>0?F:$.length,_=b!==-1||F!==-1?$.slice(0,Math.min(L,B)):$,ee=u.elm=Q(S)&&Q(C=S.ns)?i.createElementNS(C,_,S):i.createElement(_,S);for(L<B&&ee.setAttribute("id",$.slice(L+1,B)),F>0&&ee.setAttribute("class",$.slice(B+1).replace(/\./g," ")),C=0;C<n.create.length;++C)n.create[C](bt,u);if(it(u.text)&&(!ot(A)||A.length===0)&&i.appendChild(ee,i.createTextNode(u.text)),ot(A))for(C=0;C<A.length;++C){const kr=A[C];kr!=null&&i.appendChild(ee,c(kr,f))}const rt=u.data.hook;Q(rt)&&((g=rt.create)===null||g===void 0||g.call(rt,bt,u),rt.insert&&f.push(u))}else if(!((y=void 0)===null||y===void 0)&&y.fragments&&u.children){for(u.elm=((R=i.createDocumentFragment)!==null&&R!==void 0?R:mi)(),C=0;C<n.create.length;++C)n.create[C](bt,u);for(C=0;C<u.children.length;++C){const b=u.children[C];b!=null&&i.appendChild(u.elm,c(b,f))}}else u.elm=i.createTextNode(u.text);return u.elm}function l(u,f,k,g,y,R){for(;g<=y;++g){const C=k[g];C!=null&&i.insertBefore(u,c(C,R),f)}}function m(u){var f,k;const g=u.data;if(g!==void 0){(k=(f=g==null?void 0:g.hook)===null||f===void 0?void 0:f.destroy)===null||k===void 0||k.call(f,u);for(let y=0;y<n.destroy.length;++y)n.destroy[y](u);if(u.children!==void 0)for(let y=0;y<u.children.length;++y){const R=u.children[y];R!=null&&typeof R!="string"&&m(R)}}}function p(u,f,k,g){for(var y,R;k<=g;++k){let C,S;const A=f[k];if(A!=null)if(Q(A.sel)){m(A),C=n.remove.length+1,S=a(A.elm,C);for(let b=0;b<n.remove.length;++b)n.remove[b](A,S);const $=(R=(y=A==null?void 0:A.data)===null||y===void 0?void 0:y.hook)===null||R===void 0?void 0:R.remove;Q($)?$(A,S):S()}else A.children?(m(A),p(u,A.children,0,A.children.length-1)):i.removeChild(u,A.elm)}}function v(u,f,k,g){let y=0,R=0,C=f.length-1,S=f[0],A=f[C],$=k.length-1,b=k[0],F=k[$],L,B,_,ee;for(;y<=C&&R<=$;)S==null?S=f[++y]:A==null?A=f[--C]:b==null?b=k[++R]:F==null?F=k[--$]:_e(S,b)?(w(S,b,g),S=f[++y],b=k[++R]):_e(A,F)?(w(A,F,g),A=f[--C],F=k[--$]):_e(S,F)?(w(S,F,g),i.insertBefore(u,S.elm,i.nextSibling(A.elm)),S=f[++y],F=k[--$]):_e(A,b)?(w(A,b,g),i.insertBefore(u,A.elm,S.elm),A=f[--C],b=k[++R]):(L===void 0&&(L=bi(f,y,C)),B=L[b.key],nt(B)?(i.insertBefore(u,c(b,g),S.elm),b=k[++R]):nt(L[F.key])?(i.insertBefore(u,c(F,g),i.nextSibling(A.elm)),F=k[--$]):(_=f[B],_.sel!==b.sel?i.insertBefore(u,c(b,g),S.elm):(w(_,b,g),f[B]=void 0,i.insertBefore(u,_.elm,S.elm)),b=k[++R]));R<=$&&(ee=k[$+1]==null?null:k[$+1].elm,l(u,ee,k,R,$,g)),y<=C&&p(u,f,y,C)}function w(u,f,k){var g,y,R,C,S,A,$,b;const F=(g=f.data)===null||g===void 0?void 0:g.hook;(y=F==null?void 0:F.prepatch)===null||y===void 0||y.call(F,u,f);const L=f.elm=u.elm;if(u===f)return;if(f.data!==void 0||Q(f.text)&&f.text!==u.text){(R=f.data)!==null&&R!==void 0||(f.data={}),(C=u.data)!==null&&C!==void 0||(u.data={});for(let ee=0;ee<n.update.length;++ee)n.update[ee](u,f);($=(A=(S=f.data)===null||S===void 0?void 0:S.hook)===null||A===void 0?void 0:A.update)===null||$===void 0||$.call(A,u,f)}const B=u.children,_=f.children;nt(f.text)?Q(B)&&Q(_)?B!==_&&v(L,B,_,k):Q(_)?(Q(u.text)&&i.setTextContent(L,""),l(L,null,_,0,_.length-1,k)):Q(B)?p(L,B,0,B.length-1):Q(u.text)&&i.setTextContent(L,""):u.text!==f.text&&(Q(B)&&p(L,B,0,B.length-1),i.setTextContent(L,f.text)),(b=F==null?void 0:F.postpatch)===null||b===void 0||b.call(F,u,f)}return function(f,k){let g,y,R;const C=[];for(g=0;g<n.pre.length;++g)n.pre[g]();for(gi(i,f)?f=s(f):ki(i,f)&&(f=o(f)),_e(f,k)?w(f,k,C):(y=f.elm,R=i.parentNode(y),c(k,C),R!==null&&(i.insertBefore(R,k.elm,i.nextSibling(y)),p(R,[f],0,0))),g=0;g<C.length;++g)C[g].data.hook.insert(C[g]);for(g=0;g<n.post.length;++g)n.post[g]();return k}}function Yr(t,e,r){if(t.ns="http://www.w3.org/2000/svg",r!=="foreignObject"&&e!==void 0)for(let n=0;n<e.length;++n){const i=e[n];if(typeof i=="string")continue;const s=i.data;s!==void 0&&Yr(s,i.children,i.sel)}}function E(t,e,r){let n={},i,s,o;if(r!==void 0?(e!==null&&(n=e),ot(r)?i=r:it(r)?s=r.toString():r&&r.sel&&(i=[r])):e!=null&&(ot(e)?i=e:it(e)?s=e.toString():e&&e.sel?i=[e]:n=e),i!==void 0)for(o=0;o<i.length;++o)it(i[o])&&(i[o]=Ge(void 0,void 0,void 0,i[o],void 0));return t.startsWith("svg")&&(t.length===3||t[3]==="."||t[3]==="#")&&Yr(n,i,t),Ge(t,n,i,s,void 0)}const yi="http://www.w3.org/1999/xlink",Ci="http://www.w3.org/2000/xmlns/",Si="http://www.w3.org/XML/1998/namespace",br=58,Ei=120,xi=109;function wr(t,e){let r;const n=e.elm;let i=t.data.attrs,s=e.data.attrs;if(!(!i&&!s)&&i!==s){i=i||{},s=s||{};for(r in s){const o=s[r];i[r]!==o&&(o===!0?n.setAttribute(r,""):o===!1?n.removeAttribute(r):r.charCodeAt(0)!==Ei?n.setAttribute(r,o):r.charCodeAt(3)===br?n.setAttributeNS(Si,r,o):r.charCodeAt(5)===br?r.charCodeAt(1)===xi?n.setAttributeNS(Ci,r,o):n.setAttributeNS(yi,r,o):n.setAttribute(r,o))}for(r in i)r in s||n.removeAttribute(r)}}const Ai={create:wr,update:wr};function vr(t,e){let r,n;const i=e.elm;let s=t.data.class,o=e.data.class;if(!(!s&&!o)&&s!==o){s=s||{},o=o||{};for(n in s)s[n]&&!Object.prototype.hasOwnProperty.call(o,n)&&i.classList.remove(n);for(n in o)r=o[n],r!==s[n]&&i.classList[r?"add":"remove"](n)}}const Mi={create:vr,update:vr};function Xr(t,e,r){if(typeof t=="function")t.call(e,r,e);else if(typeof t=="object")for(let n=0;n<t.length;n++)Xr(t[n],e,r)}function Ri(t,e){const r=t.type,n=e.data.on;n&&n[r]&&Xr(n[r],e,t)}function Pi(){return function t(e){Ri(e,t.vnode)}}function wt(t,e){const r=t.data.on,n=t.listener,i=t.elm,s=e&&e.data.on,o=e&&e.elm;let a;if(r!==s){if(r&&n)if(s)for(a in r)s[a]||i.removeEventListener(a,n,!1);else for(a in r)i.removeEventListener(a,n,!1);if(s){const c=e.listener=t.listener||Pi();if(c.vnode=e,r)for(a in s)r[a]||o.addEventListener(a,c,!1);else for(a in s)o.addEventListener(a,c,!1)}}}const Oi={create:wt,update:wt,destroy:wt};function yr(t,e){let r,n,i;const s=e.elm;let o=t.data.props,a=e.data.props;if(!(!o&&!a)&&o!==a){o=o||{},a=a||{};for(r in a)n=a[r],i=o[r],i!==n&&(r!=="value"||s[r]!==n)&&(s[r]=n)}}const Ni={create:yr,update:yr},Cr=typeof(window==null?void 0:window.requestAnimationFrame)=="function"?window.requestAnimationFrame.bind(window):setTimeout,$i=function(t){Cr(function(){Cr(t)})};let Pt=!1;function Ti(t,e,r){$i(function(){t[e]=r})}function Sr(t,e){let r,n;const i=e.elm;let s=t.data.style,o=e.data.style;if(!s&&!o||s===o)return;s=s||{},o=o||{};const a="delayed"in s;for(n in s)n in o||(n[0]==="-"&&n[1]==="-"?i.style.removeProperty(n):i.style[n]="");for(n in o)if(r=o[n],n==="delayed"&&o.delayed)for(const c in o.delayed)r=o.delayed[c],(!a||r!==s.delayed[c])&&Ti(i.style,c,r);else n!=="remove"&&r!==s[n]&&(n[0]==="-"&&n[1]==="-"?i.style.setProperty(n,r):i.style[n]=r)}function Di(t){let e,r;const n=t.elm,i=t.data.style;if(!(!i||!(e=i.destroy)))for(r in e)n.style[r]=e[r]}function Fi(t,e){const r=t.data.style;if(!r||!r.remove){e();return}Pt||(t.elm.offsetLeft,Pt=!0);let n;const i=t.elm;let s=0;const o=r.remove;let a=0;const c=[];for(n in o)c.push(n),i.style[n]=o[n];const m=getComputedStyle(i)["transition-property"].split(", ");for(;s<m.length;++s)c.indexOf(m[s])!==-1&&a++;i.addEventListener("transitionend",function(p){p.target===i&&--a,a===0&&e()})}function Bi(){Pt=!1}const Li={pre:Bi,create:Sr,update:Sr,destroy:Di,remove:Fi};var Jr=["a","b","c","d","e","f","g","h"],Ki=["1","2","3","4","5","6","7","8"],se=["white","black"],te=["pawn","knight","bishop","rook","queen","king"],Ii=["a","h"],Ot=t=>"role"in t,O=t=>t!==void 0,T=t=>t==="white"?"black":"white",Je=t=>t>>3,le=t=>t&7,zi=(t,e)=>0<=t&&t<8&&0<=e&&e<8?t+8*e:void 0,en=t=>{switch(t){case"pawn":return"p";case"knight":return"n";case"bishop":return"b";case"rook":return"r";case"queen":return"q";case"king":return"k"}};function vt(t){switch(t.toLowerCase()){case"p":return"pawn";case"n":return"knight";case"b":return"bishop";case"r":return"rook";case"q":return"queen";case"k":return"king";default:return}}function Er(t){if(t.length===2)return zi(t.charCodeAt(0)-97,t.charCodeAt(1)-49)}var _i=t=>Jr[le(t)]+Ki[Je(t)],Yt=(t,e)=>t==="white"?e==="a"?2:6:e==="a"?58:62,Xt=(t,e)=>t==="white"?e==="a"?3:5:e==="a"?59:61,tn=class{unwrap(e,r){const n=this._chain(i=>D.ok(e?e(i):i),i=>r?D.ok(r(i)):D.err(i));if(n.isErr)throw n.error;return n.value}map(e,r){return this._chain(n=>D.ok(e(n)),n=>D.err(r?r(n):n))}chain(e,r){return this._chain(e,r||(n=>D.err(n)))}},qi=class extends tn{constructor(e){super(),this.value=void 0,this.isOk=!0,this.isErr=!1,this.value=e}_chain(e,r){return e(this.value)}},ji=class extends tn{constructor(e){super(),this.error=void 0,this.isOk=!1,this.isErr=!0,this.error=e}_chain(e,r){return r(this.error)}},D;(function(t){t.ok=function(e){return new qi(e)},t.err=function(e){return new ji(e||new Error)},t.all=function(e){if(Array.isArray(e)){const i=[];for(let s=0;s<e.length;s++){const o=e[s];if(o.isErr)return o;i.push(o.value)}return t.ok(i)}const r={},n=Object.keys(e);for(let i=0;i<n.length;i++){const s=e[n[i]];if(s.isErr)return s;r[n[i]]=s.value}return t.ok(r)}})(D||(D={}));var xr=t=>(t=t-(t>>>1&1431655765),t=(t&858993459)+(t>>>2&858993459),Math.imul(t+(t>>>4)&252645135,16843009)>>24),Nt=t=>(t=t>>>8&16711935|(t&16711935)<<8,t>>>16&65535|(t&65535)<<16),Ar=t=>(t=t>>>1&1431655765|(t&1431655765)<<1,t=t>>>2&858993459|(t&858993459)<<2,t=t>>>4&252645135|(t&252645135)<<4,Nt(t)),h=class N{constructor(e,r){this.lo=e|0,this.hi=r|0}static fromSquare(e){return e>=32?new N(0,1<<e-32):new N(1<<e,0)}static fromRank(e){return new N(255,0).shl64(8*e)}static fromFile(e){return new N(16843009<<e,16843009<<e)}static empty(){return new N(0,0)}static full(){return new N(4294967295,4294967295)}static corners(){return new N(129,2164260864)}static center(){return new N(402653184,24)}static backranks(){return new N(255,4278190080)}static backrank(e){return e==="white"?new N(255,0):new N(0,4278190080)}static lightSquares(){return new N(1437226410,1437226410)}static darkSquares(){return new N(2857740885,2857740885)}complement(){return new N(~this.lo,~this.hi)}xor(e){return new N(this.lo^e.lo,this.hi^e.hi)}union(e){return new N(this.lo|e.lo,this.hi|e.hi)}intersect(e){return new N(this.lo&e.lo,this.hi&e.hi)}diff(e){return new N(this.lo&~e.lo,this.hi&~e.hi)}intersects(e){return this.intersect(e).nonEmpty()}isDisjoint(e){return this.intersect(e).isEmpty()}supersetOf(e){return e.diff(this).isEmpty()}subsetOf(e){return this.diff(e).isEmpty()}shr64(e){return e>=64?N.empty():e>=32?new N(this.hi>>>e-32,0):e>0?new N(this.lo>>>e^this.hi<<32-e,this.hi>>>e):this}shl64(e){return e>=64?N.empty():e>=32?new N(0,this.lo<<e-32):e>0?new N(this.lo<<e,this.hi<<e^this.lo>>>32-e):this}bswap64(){return new N(Nt(this.hi),Nt(this.lo))}rbit64(){return new N(Ar(this.hi),Ar(this.lo))}minus64(e){const r=this.lo-e.lo,n=(r&e.lo&1)+(e.lo>>>1)+(r>>>1)>>>31;return new N(r,this.hi-(e.hi+n))}equals(e){return this.lo===e.lo&&this.hi===e.hi}size(){return xr(this.lo)+xr(this.hi)}isEmpty(){return this.lo===0&&this.hi===0}nonEmpty(){return this.lo!==0||this.hi!==0}has(e){return(e>=32?this.hi&1<<e-32:this.lo&1<<e)!==0}set(e,r){return r?this.with(e):this.without(e)}with(e){return e>=32?new N(this.lo,this.hi|1<<e-32):new N(this.lo|1<<e,this.hi)}without(e){return e>=32?new N(this.lo,this.hi&~(1<<e-32)):new N(this.lo&~(1<<e),this.hi)}toggle(e){return e>=32?new N(this.lo,this.hi^1<<e-32):new N(this.lo^1<<e,this.hi)}last(){if(this.hi!==0)return 63-Math.clz32(this.hi);if(this.lo!==0)return 31-Math.clz32(this.lo)}first(){if(this.lo!==0)return 31-Math.clz32(this.lo&-this.lo);if(this.hi!==0)return 63-Math.clz32(this.hi&-this.hi)}withoutFirst(){return this.lo!==0?new N(this.lo&this.lo-1,this.hi):new N(0,this.hi&this.hi-1)}moreThanOne(){return this.hi!==0&&this.lo!==0||(this.lo&this.lo-1)!==0||(this.hi&this.hi-1)!==0}singleSquare(){return this.moreThanOne()?void 0:this.last()}*[Symbol.iterator](){let e=this.lo,r=this.hi;for(;e!==0;){const n=31-Math.clz32(e&-e);e^=1<<n,yield n}for(;r!==0;){const n=31-Math.clz32(r&-r);r^=1<<n,yield 32+n}}*reversed(){let e=this.lo,r=this.hi;for(;r!==0;){const n=31-Math.clz32(r);r^=1<<n,yield 32+n}for(;e!==0;){const n=31-Math.clz32(e);e^=1<<n,yield n}}},Jt=class st{constructor(){}static default(){const e=new st;return e.reset(),e}reset(){this.occupied=new h(65535,4294901760),this.promoted=h.empty(),this.white=new h(65535,0),this.black=new h(0,4294901760),this.pawn=new h(65280,16711680),this.knight=new h(66,1107296256),this.bishop=new h(36,603979776),this.rook=new h(129,2164260864),this.queen=new h(8,134217728),this.king=new h(16,268435456)}static empty(){const e=new st;return e.clear(),e}clear(){this.occupied=h.empty(),this.promoted=h.empty();for(const e of se)this[e]=h.empty();for(const e of te)this[e]=h.empty()}clone(){const e=new st;e.occupied=this.occupied,e.promoted=this.promoted;for(const r of se)e[r]=this[r];for(const r of te)e[r]=this[r];return e}getColor(e){if(this.white.has(e))return"white";if(this.black.has(e))return"black"}getRole(e){for(const r of te)if(this[r].has(e))return r}get(e){const r=this.getColor(e);if(!r)return;const n=this.getRole(e),i=this.promoted.has(e);return{color:r,role:n,promoted:i}}take(e){const r=this.get(e);return r&&(this.occupied=this.occupied.without(e),this[r.color]=this[r.color].without(e),this[r.role]=this[r.role].without(e),r.promoted&&(this.promoted=this.promoted.without(e))),r}set(e,r){const n=this.take(e);return this.occupied=this.occupied.with(e),this[r.color]=this[r.color].with(e),this[r.role]=this[r.role].with(e),r.promoted&&(this.promoted=this.promoted.with(e)),n}has(e){return this.occupied.has(e)}*[Symbol.iterator](){for(const e of this.occupied)yield[e,this.get(e)]}pieces(e,r){return this[e].intersect(this[r])}rooksAndQueens(){return this.rook.union(this.queen)}bishopsAndQueens(){return this.bishop.union(this.queen)}kingOf(e){return this.pieces(e,"king").singleSquare()}},Oe=class Re{constructor(){}static empty(){const e=new Re;for(const r of te)e[r]=0;return e}static fromBoard(e,r){const n=new Re;for(const i of te)n[i]=e.pieces(r,i).size();return n}clone(){const e=new Re;for(const r of te)e[r]=this[r];return e}equals(e){return te.every(r=>this[r]===e[r])}add(e){const r=new Re;for(const n of te)r[n]=this[n]+e[n];return r}subtract(e){const r=new Re;for(const n of te)r[n]=this[n]-e[n];return r}nonEmpty(){return te.some(e=>this[e]>0)}isEmpty(){return!this.nonEmpty()}hasPawns(){return this.pawn>0}hasNonPawns(){return this.knight>0||this.bishop>0||this.rook>0||this.queen>0||this.king>0}size(){return this.pawn+this.knight+this.bishop+this.rook+this.queen+this.king}},Mr=class Pe{constructor(e,r){this.white=e,this.black=r}static empty(){return new Pe(Oe.empty(),Oe.empty())}static fromBoard(e){return new Pe(Oe.fromBoard(e,"white"),Oe.fromBoard(e,"black"))}clone(){return new Pe(this.white.clone(),this.black.clone())}equals(e){return this.white.equals(e.white)&&this.black.equals(e.black)}add(e){return new Pe(this.white.add(e.white),this.black.add(e.black))}subtract(e){return new Pe(this.white.subtract(e.white),this.black.subtract(e.black))}count(e){return this.white[e]+this.black[e]}size(){return this.white.size()+this.black.size()}isEmpty(){return this.white.isEmpty()&&this.black.isEmpty()}nonEmpty(){return!this.isEmpty()}hasPawns(){return this.white.hasPawns()||this.black.hasPawns()}hasNonPawns(){return this.white.hasNonPawns()||this.black.hasNonPawns()}},Rr=class $t{constructor(e,r){this.white=e,this.black=r}static default(){return new $t(3,3)}clone(){return new $t(this.white,this.black)}equals(e){return this.white===e.white&&this.black===e.black}},Pr;(function(t){t.Fen="ERR_FEN",t.Board="ERR_BOARD",t.Pockets="ERR_POCKETS",t.Turn="ERR_TURN",t.Castling="ERR_CASTLING",t.EpSquare="ERR_EP_SQUARE",t.RemainingChecks="ERR_REMAINING_CHECKS",t.Halfmoves="ERR_HALFMOVES",t.Fullmoves="ERR_FULLMOVES"})(Pr||(Pr={}));var Hi=t=>{let e=en(t.role);return t.color==="white"&&(e=e.toUpperCase()),t.promoted&&(e+="~"),e},Wi=t=>{let e="",r=0;for(let n=7;n>=0;n--)for(let i=0;i<8;i++){const s=i+n*8,o=t.get(s);o?(r>0&&(e+=r,r=0),e+=Hi(o)):r++,i===7&&(r>0&&(e+=r,r=0),n!==0&&(e+="/"))}return e},Or=t=>te.map(e=>en(e).repeat(t[e])).join(""),Gi=t=>Or(t.white).toUpperCase()+Or(t.black),Ui=(t,e)=>{let r="";for(const n of se){const i=h.backrank(n);let s=t.kingOf(n);O(s)&&!i.has(s)&&(s=void 0);const o=t.pieces(n,"rook").intersect(i);for(const a of e.intersect(i).reversed())if(a===o.first()&&O(s)&&a<s)r+=n==="white"?"Q":"q";else if(a===o.last()&&O(s)&&s<a)r+=n==="white"?"K":"k";else{const c=Jr[le(a)];r+=n==="white"?c.toUpperCase():c}}return r||"-"},Qi=t=>`${t.white}+${t.black}`,Zi=(t,e)=>[Wi(t.board)+(t.pockets?`[${Gi(t.pockets)}]`:""),t.turn[0],Ui(t.board,t.castlingRights),O(t.epSquare)?_i(t.epSquare):"-",...t.remainingChecks?[Qi(t.remainingChecks)]:[],Math.max(0,Math.min(t.halfmoves,9999)),Math.max(1,Math.min(t.fullmoves,9999))].join(" "),at=(t,e)=>{let r=h.empty();for(const n of e){const i=t+n;0<=i&&i<64&&Math.abs(le(t)-le(i))<=2&&(r=r.with(i))}return r},de=t=>{const e=[];for(let r=0;r<64;r++)e[r]=t(r);return e},Vi=de(t=>at(t,[-9,-8,-7,-1,1,7,8,9])),Yi=de(t=>at(t,[-17,-15,-10,-6,6,10,15,17])),Xi={white:de(t=>at(t,[7,9])),black:de(t=>at(t,[-7,-9]))},Fe=t=>Vi[t],er=t=>Yi[t],ze=(t,e)=>Xi[t][e],Tt=de(t=>h.fromFile(le(t)).without(t)),Dt=de(t=>h.fromRank(Je(t)).without(t)),Ft=de(t=>{const e=new h(134480385,2151686160),r=8*(Je(t)-le(t));return(r>=0?e.shl64(r):e.shr64(-r)).without(t)}),Bt=de(t=>{const e=new h(270549120,16909320),r=8*(Je(t)+le(t)-7);return(r>=0?e.shl64(r):e.shr64(-r)).without(t)}),Lt=(t,e,r)=>{let n=r.intersect(e),i=n.bswap64();return n=n.minus64(t),i=i.minus64(t.bswap64()),n.xor(i.bswap64()).intersect(e)},Ji=(t,e)=>Lt(h.fromSquare(t),Tt[t],e),es=(t,e)=>{const r=Dt[t];let n=e.intersect(r),i=n.rbit64();return n=n.minus64(h.fromSquare(t)),i=i.minus64(h.fromSquare(63-t)),n.xor(i.rbit64()).intersect(r)},Ue=(t,e)=>{const r=h.fromSquare(t);return Lt(r,Ft[t],e).xor(Lt(r,Bt[t],e))},Qe=(t,e)=>Ji(t,e).xor(es(t,e)),rn=(t,e)=>Ue(t,e).xor(Qe(t,e)),nn=(t,e,r)=>{switch(t.role){case"pawn":return ze(t.color,e);case"knight":return er(e);case"bishop":return Ue(e,r);case"rook":return Qe(e,r);case"queen":return rn(e,r);case"king":return Fe(e)}},sn=(t,e)=>{const r=h.fromSquare(e);return Dt[t].intersects(r)?Dt[t].with(t):Bt[t].intersects(r)?Bt[t].with(t):Ft[t].intersects(r)?Ft[t].with(t):Tt[t].intersects(r)?Tt[t].with(t):h.empty()},Be=(t,e)=>sn(t,e).intersect(h.full().shl64(t).xor(h.full().shl64(e))).withoutFirst(),I;(function(t){t.Empty="ERR_EMPTY",t.OppositeCheck="ERR_OPPOSITE_CHECK",t.PawnsOnBackrank="ERR_PAWNS_ON_BACKRANK",t.Kings="ERR_KINGS",t.Variant="ERR_VARIANT"})(I||(I={}));var z=class extends Error{},ts=(t,e,r,n)=>r[e].intersect(Qe(t,n).intersect(r.rooksAndQueens()).union(Ue(t,n).intersect(r.bishopsAndQueens())).union(er(t).intersect(r.knight)).union(Fe(t).intersect(r.king)).union(ze(T(e),t).intersect(r.pawn))),Ce=class He{constructor(){}static default(){const e=new He;return e.castlingRights=h.corners(),e.rook={white:{a:0,h:7},black:{a:56,h:63}},e.path={white:{a:new h(14,0),h:new h(96,0)},black:{a:new h(0,234881024),h:new h(0,1610612736)}},e}static empty(){const e=new He;return e.castlingRights=h.empty(),e.rook={white:{a:void 0,h:void 0},black:{a:void 0,h:void 0}},e.path={white:{a:h.empty(),h:h.empty()},black:{a:h.empty(),h:h.empty()}},e}clone(){const e=new He;return e.castlingRights=this.castlingRights,e.rook={white:{a:this.rook.white.a,h:this.rook.white.h},black:{a:this.rook.black.a,h:this.rook.black.h}},e.path={white:{a:this.path.white.a,h:this.path.white.h},black:{a:this.path.black.a,h:this.path.black.h}},e}add(e,r,n,i){const s=Yt(e,r),o=Xt(e,r);this.castlingRights=this.castlingRights.with(i),this.rook[e][r]=i,this.path[e][r]=Be(i,o).with(o).union(Be(n,s).with(s)).without(n).without(i)}static fromSetup(e){const r=He.empty(),n=e.castlingRights.intersect(e.board.rook);for(const i of se){const s=h.backrank(i),o=e.board.kingOf(i);if(!O(o)||!s.has(o))continue;const a=n.intersect(e.board[i]).intersect(s),c=a.first();O(c)&&c<o&&r.add(i,"a",o,c);const l=a.last();O(l)&&o<l&&r.add(i,"h",o,l)}return r}discardRook(e){if(this.castlingRights.has(e)){this.castlingRights=this.castlingRights.without(e);for(const r of se)for(const n of Ii)this.rook[r][n]===e&&(this.rook[r][n]=void 0)}}discardColor(e){this.castlingRights=this.castlingRights.diff(h.backrank(e)),this.rook[e].a=void 0,this.rook[e].h=void 0}},pe=class{constructor(e){this.rules=e}reset(){this.board=Jt.default(),this.pockets=void 0,this.turn="white",this.castles=Ce.default(),this.epSquare=void 0,this.remainingChecks=void 0,this.halfmoves=0,this.fullmoves=1}setupUnchecked(e){this.board=e.board.clone(),this.board.promoted=h.empty(),this.pockets=void 0,this.turn=e.turn,this.castles=Ce.fromSetup(e),this.epSquare=ns(this,e.epSquare),this.remainingChecks=void 0,this.halfmoves=e.halfmoves,this.fullmoves=e.fullmoves}kingAttackers(e,r,n){return ts(e,r,this.board,n)}playCaptureAt(e,r){this.halfmoves=0,r.role==="rook"&&this.castles.discardRook(e),this.pockets&&this.pockets[T(r.color)][r.promoted?"pawn":r.role]++}ctx(){const e=this.isVariantEnd(),r=this.board.kingOf(this.turn);if(!O(r))return{king:r,blockers:h.empty(),checkers:h.empty(),variantEnd:e,mustCapture:!1};const n=Qe(r,h.empty()).intersect(this.board.rooksAndQueens()).union(Ue(r,h.empty()).intersect(this.board.bishopsAndQueens())).intersect(this.board[T(this.turn)]);let i=h.empty();for(const o of n){const a=Be(r,o).intersect(this.board.occupied);a.moreThanOne()||(i=i.union(a))}const s=this.kingAttackers(r,T(this.turn),this.board.occupied);return{king:r,blockers:i,checkers:s,variantEnd:e,mustCapture:!1}}clone(){var e,r;const n=new this.constructor;return n.board=this.board.clone(),n.pockets=(e=this.pockets)===null||e===void 0?void 0:e.clone(),n.turn=this.turn,n.castles=this.castles.clone(),n.epSquare=this.epSquare,n.remainingChecks=(r=this.remainingChecks)===null||r===void 0?void 0:r.clone(),n.halfmoves=this.halfmoves,n.fullmoves=this.fullmoves,n}validate(){if(this.board.occupied.isEmpty())return D.err(new z(I.Empty));if(this.board.king.size()!==2)return D.err(new z(I.Kings));if(!O(this.board.kingOf(this.turn)))return D.err(new z(I.Kings));const e=this.board.kingOf(T(this.turn));return O(e)?this.kingAttackers(e,this.turn,this.board.occupied).nonEmpty()?D.err(new z(I.OppositeCheck)):h.backranks().intersects(this.board.pawn)?D.err(new z(I.PawnsOnBackrank)):D.ok(void 0):D.err(new z(I.Kings))}dropDests(e){return h.empty()}dests(e,r){if(r=r||this.ctx(),r.variantEnd)return h.empty();const n=this.board.get(e);if(!n||n.color!==this.turn)return h.empty();let i,s;if(n.role==="pawn"){i=ze(this.turn,e).intersect(this.board[T(this.turn)]);const o=this.turn==="white"?8:-8,a=e+o;if(0<=a&&a<64&&!this.board.occupied.has(a)){i=i.with(a);const c=this.turn==="white"?e<16:e>=48,l=a+o;c&&!this.board.occupied.has(l)&&(i=i.with(l))}O(this.epSquare)&&ss(this,e,r)&&(s=h.fromSquare(this.epSquare))}else n.role==="bishop"?i=Ue(e,this.board.occupied):n.role==="knight"?i=er(e):n.role==="rook"?i=Qe(e,this.board.occupied):n.role==="queen"?i=rn(e,this.board.occupied):i=Fe(e);if(i=i.diff(this.board[this.turn]),O(r.king)){if(n.role==="king"){const o=this.board.occupied.without(e);for(const a of i)this.kingAttackers(a,T(this.turn),o).nonEmpty()&&(i=i.without(a));return i.union(ct(this,"a",r)).union(ct(this,"h",r))}if(r.checkers.nonEmpty()){const o=r.checkers.singleSquare();if(!O(o))return h.empty();i=i.intersect(Be(o,r.king).with(o))}r.blockers.has(e)&&(i=i.intersect(sn(e,r.king)))}return s&&(i=i.union(s)),i}isVariantEnd(){return!1}variantOutcome(e){}hasInsufficientMaterial(e){return this.board[e].intersect(this.board.pawn.union(this.board.rooksAndQueens())).nonEmpty()?!1:this.board[e].intersects(this.board.knight)?this.board[e].size()<=2&&this.board[T(e)].diff(this.board.king).diff(this.board.queen).isEmpty():this.board[e].intersects(this.board.bishop)?(!this.board.bishop.intersects(h.darkSquares())||!this.board.bishop.intersects(h.lightSquares()))&&this.board.pawn.isEmpty()&&this.board.knight.isEmpty():!0}toSetup(){var e,r;return{board:this.board.clone(),pockets:(e=this.pockets)===null||e===void 0?void 0:e.clone(),turn:this.turn,castlingRights:this.castles.castlingRights,epSquare:is(this),remainingChecks:(r=this.remainingChecks)===null||r===void 0?void 0:r.clone(),halfmoves:Math.min(this.halfmoves,150),fullmoves:Math.min(Math.max(this.fullmoves,1),9999)}}isInsufficientMaterial(){return se.every(e=>this.hasInsufficientMaterial(e))}hasDests(e){e=e||this.ctx();for(const r of this.board[this.turn])if(this.dests(r,e).nonEmpty())return!0;return this.dropDests(e).nonEmpty()}isLegal(e,r){if(Ot(e))return!this.pockets||this.pockets[this.turn][e.role]<=0||e.role==="pawn"&&h.backranks().has(e.to)?!1:this.dropDests(r).has(e.to);{if(e.promotion==="pawn"||e.promotion==="king"&&this.rules!=="antichess"||!!e.promotion!==(this.board.pawn.has(e.from)&&h.backranks().has(e.to)))return!1;const n=this.dests(e.from,r);return n.has(e.to)||n.has(os(this,e).to)}}isCheck(){const e=this.board.kingOf(this.turn);return O(e)&&this.kingAttackers(e,T(this.turn),this.board.occupied).nonEmpty()}isEnd(e){return(e?e.variantEnd:this.isVariantEnd())?!0:this.isInsufficientMaterial()||!this.hasDests(e)}isCheckmate(e){return e=e||this.ctx(),!e.variantEnd&&e.checkers.nonEmpty()&&!this.hasDests(e)}isStalemate(e){return e=e||this.ctx(),!e.variantEnd&&e.checkers.isEmpty()&&!this.hasDests(e)}outcome(e){const r=this.variantOutcome(e);return r||(e=e||this.ctx(),this.isCheckmate(e)?{winner:T(this.turn)}:this.isInsufficientMaterial()||this.isStalemate(e)?{winner:void 0}:void 0)}allDests(e){e=e||this.ctx();const r=new Map;if(e.variantEnd)return r;for(const n of this.board[this.turn])r.set(n,this.dests(n,e));return r}play(e){const r=this.turn,n=this.epSquare,i=on(this,e);if(this.epSquare=void 0,this.halfmoves+=1,r==="black"&&(this.fullmoves+=1),this.turn=T(r),Ot(e))this.board.set(e.to,{role:e.role,color:r}),this.pockets&&this.pockets[r][e.role]--,e.role==="pawn"&&(this.halfmoves=0);else{const s=this.board.take(e.from);if(!s)return;let o;if(s.role==="pawn"){this.halfmoves=0,e.to===n&&(o=this.board.take(e.to+(r==="white"?-8:8)));const a=e.from-e.to;Math.abs(a)===16&&8<=e.from&&e.from<=55&&(this.epSquare=e.from+e.to>>1),e.promotion&&(s.role=e.promotion,s.promoted=!!this.pockets)}else if(s.role==="rook")this.castles.discardRook(e.from);else if(s.role==="king"){if(i){const a=this.castles.rook[r][i];if(O(a)){const c=this.board.take(a);this.board.set(Yt(r,i),s),c&&this.board.set(Xt(r,i),c)}}this.castles.discardColor(r)}if(!i){const a=this.board.set(e.to,s)||o;a&&this.playCaptureAt(e.to,a)}}this.remainingChecks&&this.isCheck()&&(this.remainingChecks[r]=Math.max(this.remainingChecks[r]-1,0))}},rs=class extends pe{constructor(){super("chess")}static default(){const e=new this;return e.reset(),e}static fromSetup(e){const r=new this;return r.setupUnchecked(e),r.validate().map(n=>r)}clone(){return super.clone()}},ns=(t,e)=>{if(!O(e))return;const r=t.turn==="white"?5:2,n=t.turn==="white"?8:-8;if(Je(e)!==r||t.board.occupied.has(e+n))return;const i=e-n;if(!(!t.board.pawn.has(i)||!t.board[T(t.turn)].has(i)))return e},is=t=>{if(!O(t.epSquare))return;const e=t.ctx(),n=t.board.pieces(t.turn,"pawn").intersect(ze(T(t.turn),t.epSquare));for(const i of n)if(t.dests(i,e).has(t.epSquare))return t.epSquare},ss=(t,e,r)=>{if(!O(t.epSquare)||!ze(t.turn,e).has(t.epSquare))return!1;if(!O(r.king))return!0;const n=t.turn==="white"?8:-8,i=t.epSquare-n;return t.kingAttackers(r.king,T(t.turn),t.board.occupied.toggle(e).toggle(i).with(t.epSquare)).without(i).isEmpty()},ct=(t,e,r)=>{if(!O(r.king)||r.checkers.nonEmpty())return h.empty();const n=t.castles.rook[t.turn][e];if(!O(n)||t.castles.path[t.turn][e].intersects(t.board.occupied))return h.empty();const i=Yt(t.turn,e),s=Be(r.king,i),o=t.board.occupied.without(r.king);for(const l of s)if(t.kingAttackers(l,T(t.turn),o).nonEmpty())return h.empty();const a=Xt(t.turn,e),c=t.board.occupied.toggle(r.king).toggle(n).toggle(a);return t.kingAttackers(i,T(t.turn),c).nonEmpty()?h.empty():h.fromSquare(n)},Kt=(t,e,r)=>{if(r.variantEnd)return h.empty();const n=t.board.get(e);if(!n||n.color!==t.turn)return h.empty();let i=nn(n,e,t.board.occupied);if(n.role==="pawn"){let s=t.board[T(t.turn)];O(t.epSquare)&&(s=s.with(t.epSquare)),i=i.intersect(s);const o=t.turn==="white"?8:-8,a=e+o;if(0<=a&&a<64&&!t.board.occupied.has(a)){i=i.with(a);const c=t.turn==="white"?e<16:e>=48,l=a+o;c&&!t.board.occupied.has(l)&&(i=i.with(l))}return i}else i=i.diff(t.board[t.turn]);return e===r.king?i.union(ct(t,"a",r)).union(ct(t,"h",r)):i},on=(t,e)=>{if(Ot(e))return;const r=e.to-e.from;if(!(Math.abs(r)!==2&&!t.board[t.turn].has(e.to))&&t.board.king.has(e.from))return r>0?"h":"a"},os=(t,e)=>{const r=on(t,e);if(!r)return e;const n=t.castles.rook[t.turn][r];return{from:e.from,to:O(n)?n:e.to}},as=class extends pe{constructor(){super("crazyhouse")}reset(){super.reset(),this.pockets=Mr.empty()}setupUnchecked(t){super.setupUnchecked(t),this.board.promoted=t.board.promoted.intersect(t.board.occupied).diff(t.board.king).diff(t.board.pawn),this.pockets=t.pockets?t.pockets.clone():Mr.empty()}static default(){const t=new this;return t.reset(),t}static fromSetup(t){const e=new this;return e.setupUnchecked(t),e.validate().map(r=>e)}clone(){return super.clone()}validate(){return super.validate().chain(t=>{var e,r;return!((e=this.pockets)===null||e===void 0)&&e.count("king")?D.err(new z(I.Kings)):(((r=this.pockets)===null||r===void 0?void 0:r.size())||0)+this.board.occupied.size()>64?D.err(new z(I.Variant)):D.ok(void 0)})}hasInsufficientMaterial(t){return this.pockets?this.board.occupied.size()+this.pockets.size()<=3&&this.board.pawn.isEmpty()&&this.board.promoted.isEmpty()&&this.board.rooksAndQueens().isEmpty()&&this.pockets.count("pawn")<=0&&this.pockets.count("rook")<=0&&this.pockets.count("queen")<=0:super.hasInsufficientMaterial(t)}dropDests(t){var e,r;const n=this.board.occupied.complement().intersect(!((e=this.pockets)===null||e===void 0)&&e[this.turn].hasNonPawns()?h.full():!((r=this.pockets)===null||r===void 0)&&r[this.turn].hasPawns()?h.backranks().complement():h.empty());if(t=t||this.ctx(),O(t.king)&&t.checkers.nonEmpty()){const i=t.checkers.singleSquare();return O(i)?n.intersect(Be(i,t.king)):h.empty()}else return n}},cs=class extends pe{constructor(){super("atomic")}static default(){const t=new this;return t.reset(),t}static fromSetup(t){const e=new this;return e.setupUnchecked(t),e.validate().map(r=>e)}clone(){return super.clone()}validate(){if(this.board.occupied.isEmpty())return D.err(new z(I.Empty));if(this.board.king.size()>2)return D.err(new z(I.Kings));const t=this.board.kingOf(T(this.turn));return O(t)?this.kingAttackers(t,this.turn,this.board.occupied).nonEmpty()?D.err(new z(I.OppositeCheck)):h.backranks().intersects(this.board.pawn)?D.err(new z(I.PawnsOnBackrank)):D.ok(void 0):D.err(new z(I.Kings))}kingAttackers(t,e,r){const n=this.board.pieces(e,"king");return n.isEmpty()||Fe(t).intersects(n)?h.empty():super.kingAttackers(t,e,r)}playCaptureAt(t,e){super.playCaptureAt(t,e),this.board.take(t);for(const r of Fe(t).intersect(this.board.occupied).diff(this.board.pawn)){const n=this.board.take(r);(n==null?void 0:n.role)==="rook"&&this.castles.discardRook(r),(n==null?void 0:n.role)==="king"&&this.castles.discardColor(n.color)}}hasInsufficientMaterial(t){if(this.board.pieces(T(t),"king").isEmpty())return!1;if(this.board[t].diff(this.board.king).isEmpty())return!0;if(this.board[T(t)].diff(this.board.king).nonEmpty()){if(this.board.occupied.equals(this.board.bishop.union(this.board.king))){if(!this.board.bishop.intersect(this.board.white).intersects(h.darkSquares()))return!this.board.bishop.intersect(this.board.black).intersects(h.lightSquares());if(!this.board.bishop.intersect(this.board.white).intersects(h.lightSquares()))return!this.board.bishop.intersect(this.board.black).intersects(h.darkSquares())}return!1}return this.board.queen.nonEmpty()||this.board.pawn.nonEmpty()?!1:this.board.knight.union(this.board.bishop).union(this.board.rook).size()===1?!0:this.board.occupied.equals(this.board.knight.union(this.board.king))?this.board.knight.size()<=2:!1}dests(t,e){e=e||this.ctx();let r=h.empty();for(const n of Kt(this,t,e)){const i=this.clone();i.play({from:t,to:n});const s=i.board.kingOf(this.turn);O(s)&&(!O(i.board.kingOf(i.turn))||i.kingAttackers(s,i.turn,i.board.occupied).isEmpty())&&(r=r.with(n))}return r}isVariantEnd(){return!!this.variantOutcome()}variantOutcome(t){for(const e of se)if(this.board.pieces(e,"king").isEmpty())return{winner:T(e)}}},ls=class extends pe{constructor(){super("antichess")}reset(){super.reset(),this.castles=Ce.empty()}setupUnchecked(t){super.setupUnchecked(t),this.castles=Ce.empty()}static default(){const t=new this;return t.reset(),t}static fromSetup(t){const e=new this;return e.setupUnchecked(t),e.validate().map(r=>e)}clone(){return super.clone()}validate(){return this.board.occupied.isEmpty()?D.err(new z(I.Empty)):h.backranks().intersects(this.board.pawn)?D.err(new z(I.PawnsOnBackrank)):D.ok(void 0)}kingAttackers(t,e,r){return h.empty()}ctx(){const t=super.ctx();if(O(this.epSquare)&&ze(T(this.turn),this.epSquare).intersects(this.board.pieces(this.turn,"pawn")))return t.mustCapture=!0,t;const e=this.board[T(this.turn)];for(const r of this.board[this.turn])if(Kt(this,r,t).intersects(e))return t.mustCapture=!0,t;return t}dests(t,e){e=e||this.ctx();const r=Kt(this,t,e),n=this.board[T(this.turn)];return r.intersect(e.mustCapture?O(this.epSquare)&&this.board.getRole(t)==="pawn"?n.with(this.epSquare):n:h.full())}hasInsufficientMaterial(t){if(this.board[t].isEmpty())return!1;if(this.board[T(t)].isEmpty())return!0;if(this.board.occupied.equals(this.board.bishop)){const e=this.board[t].intersects(h.lightSquares()),r=this.board[t].intersects(h.darkSquares()),n=this.board[T(t)].isDisjoint(h.lightSquares()),i=this.board[T(t)].isDisjoint(h.darkSquares());return e&&n||r&&i}return this.board.occupied.equals(this.board.knight)&&this.board.occupied.size()===2?this.board.white.intersects(h.lightSquares())!==this.board.black.intersects(h.darkSquares())!=(this.turn===t):!1}isVariantEnd(){return this.board[this.turn].isEmpty()}variantOutcome(t){if(t=t||this.ctx(),t.variantEnd||this.isStalemate(t))return{winner:this.turn}}},hs=class extends pe{constructor(){super("kingofthehill")}static default(){const t=new this;return t.reset(),t}static fromSetup(t){const e=new this;return e.setupUnchecked(t),e.validate().map(r=>e)}clone(){return super.clone()}hasInsufficientMaterial(t){return!1}isVariantEnd(){return this.board.king.intersects(h.center())}variantOutcome(t){for(const e of se)if(this.board.pieces(e,"king").intersects(h.center()))return{winner:e}}},us=class extends pe{constructor(){super("3check")}reset(){super.reset(),this.remainingChecks=Rr.default()}setupUnchecked(t){var e;super.setupUnchecked(t),this.remainingChecks=((e=t.remainingChecks)===null||e===void 0?void 0:e.clone())||Rr.default()}static default(){const t=new this;return t.reset(),t}static fromSetup(t){const e=new this;return e.setupUnchecked(t),e.validate().map(r=>e)}clone(){return super.clone()}hasInsufficientMaterial(t){return this.board.pieces(t,"king").equals(this.board[t])}isVariantEnd(){return!!this.remainingChecks&&(this.remainingChecks.white<=0||this.remainingChecks.black<=0)}variantOutcome(t){if(this.remainingChecks){for(const e of se)if(this.remainingChecks[e]<=0)return{winner:e}}}},ds=()=>{const t=Jt.empty();return t.occupied=new h(65535,0),t.promoted=h.empty(),t.white=new h(61680,0),t.black=new h(3855,0),t.pawn=h.empty(),t.knight=new h(6168,0),t.bishop=new h(9252,0),t.rook=new h(16962,0),t.queen=new h(129,0),t.king=new h(33024,0),t},fs=class extends pe{constructor(){super("racingkings")}reset(){this.board=ds(),this.pockets=void 0,this.turn="white",this.castles=Ce.empty(),this.epSquare=void 0,this.remainingChecks=void 0,this.halfmoves=0,this.fullmoves=1}setupUnchecked(t){super.setupUnchecked(t),this.castles=Ce.empty()}static default(){const t=new this;return t.reset(),t}static fromSetup(t){const e=new this;return e.setupUnchecked(t),e.validate().map(r=>e)}clone(){return super.clone()}validate(){return this.isCheck()||this.board.pawn.nonEmpty()?D.err(new z(I.Variant)):super.validate()}dests(t,e){if(e=e||this.ctx(),t===e.king)return super.dests(t,e);let r=h.empty();for(const n of super.dests(t,e)){const i={from:t,to:n},s=this.clone();s.play(i),s.isCheck()||(r=r.with(n))}return r}hasInsufficientMaterial(t){return!1}isVariantEnd(){const t=h.fromRank(7),e=this.board.king.intersect(t);if(e.isEmpty())return!1;if(this.turn==="white"||e.intersects(this.board.black))return!0;const r=this.board.kingOf("black");if(O(r)){const n=this.board.occupied.without(r);for(const i of Fe(r).intersect(t).diff(this.board.black))if(this.kingAttackers(i,"white",n).isEmpty())return!1}return!0}variantOutcome(t){if(t?!t.variantEnd:!this.isVariantEnd())return;const e=h.fromRank(7),r=this.board.pieces("black","king").intersects(e),n=this.board.pieces("white","king").intersects(e);return r&&!n?{winner:"black"}:n&&!r?{winner:"white"}:{winner:void 0}}},ps=()=>{const t=Jt.empty();return t.occupied=new h(4294967295,4294901862),t.promoted=h.empty(),t.white=new h(4294967295,102),t.black=new h(0,4294901760),t.pawn=new h(4294967295,16711782),t.knight=new h(0,1107296256),t.bishop=new h(0,603979776),t.rook=new h(0,2164260864),t.queen=new h(0,134217728),t.king=new h(0,268435456),t},ms=class extends pe{constructor(){super("horde")}reset(){this.board=ps(),this.pockets=void 0,this.turn="white",this.castles=Ce.default(),this.castles.discardColor("white"),this.epSquare=void 0,this.remainingChecks=void 0,this.halfmoves=0,this.fullmoves=1}static default(){const t=new this;return t.reset(),t}static fromSetup(t){const e=new this;return e.setupUnchecked(t),e.validate().map(r=>e)}clone(){return super.clone()}validate(){if(this.board.occupied.isEmpty())return D.err(new z(I.Empty));if(this.board.king.size()!==1)return D.err(new z(I.Kings));const t=this.board.kingOf(T(this.turn));if(O(t)&&this.kingAttackers(t,this.turn,this.board.occupied).nonEmpty())return D.err(new z(I.OppositeCheck));for(const e of se){const r=this.board.pieces(e,"king").isEmpty()?h.backrank(T(e)):h.backranks();if(this.board.pieces(e,"pawn").intersects(r))return D.err(new z(I.PawnsOnBackrank))}return D.ok(void 0)}hasInsufficientMaterial(t){if(this.board.pieces(t,"king").nonEmpty())return!1;const e=v=>v==="light"?"dark":"light",r=v=>v==="light"?h.lightSquares():h.darkSquares(),n=v=>{const w=this.board.pieces(v,"bishop");return w.intersects(h.darkSquares())&&w.intersects(h.lightSquares())},i=Oe.fromBoard(this.board,t),s=v=>r(v).intersect(this.board.pieces(t,"bishop")).size(),o=s("light")>=1?"light":"dark",a=i.pawn+i.knight+i.rook+i.queen+Math.min(s("dark"),2)+Math.min(s("light"),2),c=Oe.fromBoard(this.board,T(t)),l=v=>r(v).intersect(this.board.pieces(T(t),"bishop")).size(),m=c.size(),p=v=>m-v;if(a===0)return!0;if(a>=4||(i.pawn>=1||i.queen>=1)&&a>=2||i.rook>=1&&a>=2&&!(a===2&&i.rook===1&&i.bishop===1&&p(l(o))===1))return!1;if(a===1){if(m===1)return!0;if(i.queen===1)return!(c.pawn>=1||c.rook>=1||l("light")>=2||l("dark")>=2);if(i.pawn===1){const v=this.board.pieces(t,"pawn").last(),w=this.clone();w.board.set(v,{color:t,role:"queen"});const u=this.clone();return u.board.set(v,{color:t,role:"knight"}),w.hasInsufficientMaterial(t)&&u.hasInsufficientMaterial(t)}else{if(i.rook===1)return!(c.pawn>=2||c.rook>=1&&c.pawn>=1||c.rook>=1&&c.knight>=1||c.pawn>=1&&c.knight>=1);if(i.bishop===1)return!(l(e(o))>=2||l(e(o))>=1&&c.pawn>=1||c.pawn>=2);if(i.knight===1)return!(m>=4&&(c.knight>=2||c.pawn>=2||c.rook>=1&&c.knight>=1||c.rook>=1&&c.bishop>=1||c.knight>=1&&c.bishop>=1||c.rook>=1&&c.pawn>=1||c.knight>=1&&c.pawn>=1||c.bishop>=1&&c.pawn>=1||n(T(t))&&c.pawn>=1)&&(l("dark")<2||p(l("dark"))>=3)&&(l("light")<2||p(l("light"))>=3))}}else{if(a===2)return m===1?!0:i.knight===2?c.pawn+c.bishop+c.knight<1:n(t)?!(c.pawn>=1||c.bishop>=1||c.knight>=1&&c.rook+c.queen>=1):i.bishop>=1&&i.knight>=1?!(c.pawn>=1||l(e(o))>=1||p(l(o))>=3):!(c.pawn>=1&&l(e(o))>=1||c.pawn>=1&&c.knight>=1||l(e(o))>=1&&c.knight>=1||l(e(o))>=2||c.knight>=2||c.pawn>=2);if(a===3)return i.knight===2&&i.bishop===1||i.knight===3||n(t)?!1:m===1}return!0}isVariantEnd(){return this.board.white.isEmpty()||this.board.black.isEmpty()}variantOutcome(t){if(this.board.white.isEmpty())return{winner:"black"};if(this.board.black.isEmpty())return{winner:"white"}}},gs=t=>{switch(t){case"chess":return rs.default();case"antichess":return ls.default();case"atomic":return cs.default();case"horde":return ms.default();case"racingkings":return fs.default();case"kingofthehill":return hs.default();case"3check":return us.default();case"crazyhouse":return as.default()}},ks=(t=rr)=>({headers:t(),moves:new tr}),tr=class{constructor(){this.children=[]}*mainline(){let t=this;for(;t.children.length;){const e=t.children[0];yield e.data,t=e}}},an=class extends tr{constructor(t){super(),this.data=t}},bs=(t,e,r)=>{const n=new tr,i=[{before:t,after:n,ctx:e}];let s;for(;s=i.pop();)for(let o=0;o<s.before.children.length;o++){const a=o<s.before.children.length-1?s.ctx.clone():s.ctx,c=s.before.children[o],l=r(a,c.data,o);if(O(l)){const m=new an(l);s.after.children.push(m),i.push({before:c,after:m,ctx:a})}}return n},ws=(t,e,r)=>{const n=[{node:t,ctx:e}];let i;for(;i=n.pop();)for(let s=0;s<i.node.children.length;s++){const o=s<i.node.children.length-1?i.ctx.clone():i.ctx,a=i.node.children[s];r(o,a.data,s)!==!1&&n.push({node:a,ctx:o})}},rr=()=>new Map([["Event","?"],["Site","?"],["Date","????.??.??"],["Round","?"],["White","?"],["Black","?"],["Result","*"]]),Nr="\uFEFF",yt=t=>/^\s*$/.test(t),Ct=t=>t.startsWith("%"),vs=class extends Error{},ys=class{constructor(t,e=rr,r=1e6){this.emitGame=t,this.initHeaders=e,this.maxBudget=r,this.lineBuf=[],this.resetGame(),this.state=0}resetGame(){this.budget=this.maxBudget,this.found=!1,this.state=1,this.game=ks(this.initHeaders),this.stack=[{parent:this.game.moves,root:!0}],this.commentBuf=[]}consumeBudget(t){if(this.budget-=t,this.budget<0)throw new vs("ERR_PGN_BUDGET")}parse(t,e){if(!(this.budget<0))try{let r=0;for(;;){const n=t.indexOf(`
`,r);if(n===-1)break;const i=n>r&&t[n-1]==="\r"?n-1:n;this.consumeBudget(n-r),this.lineBuf.push(t.slice(r,i)),r=n+1,this.handleLine()}this.consumeBudget(t.length-r),this.lineBuf.push(t.slice(r)),e!=null&&e.stream||(this.handleLine(),this.emit(void 0))}catch(r){this.emit(r)}}handleLine(){let t=!0,e=this.lineBuf.join("");this.lineBuf=[];e:for(;;)switch(this.state){case 0:e.startsWith(Nr)&&(e=e.slice(Nr.length)),this.state=1;case 1:if(yt(e)||Ct(e))return;this.found=!0,this.state=2;case 2:{if(Ct(e))return;let r=!0;for(;r;)r=!1,e=e.replace(/^\s*\[([A-Za-z0-9][A-Za-z0-9_+#=:-]*)\s+"((?:[^"\\]|\\"|\\\\)*)"\]/,(n,i,s)=>(this.consumeBudget(200),this.game.headers.set(i,s.replace(/\\"/g,'"').replace(/\\\\/g,"\\")),r=!0,t=!1,""));if(yt(e))return;this.state=3}case 3:{if(t){if(Ct(e))return;if(yt(e))return this.emit(void 0)}const r=/(?:[NBKRQ]?[a-h]?[1-8]?[-x]?[a-h][1-8](?:=?[nbrqkNBRQK])?|[pnbrqkPNBRQK]?@[a-h][1-8]|O-O-O|0-0-0|O-O|0-0)[+#]?|--|Z0|0000|@@@@|{|;|\$\d{1,4}|[?!]{1,2}|\(|\)|\*|1-0|0-1|1\/2-1\/2/g;let n;for(;n=r.exec(e);){const i=this.stack[this.stack.length-1];let s=n[0];if(s===";")return;if(s.startsWith("$"))this.handleNag(parseInt(s.slice(1),10));else if(s==="!")this.handleNag(1);else if(s==="?")this.handleNag(2);else if(s==="!!")this.handleNag(3);else if(s==="??")this.handleNag(4);else if(s==="!?")this.handleNag(5);else if(s==="?!")this.handleNag(6);else if(s==="1-0"||s==="0-1"||s==="1/2-1/2"||s==="*")this.stack.length===1&&s!=="*"&&this.game.headers.set("Result",s);else if(s==="(")this.consumeBudget(100),this.stack.push({parent:i.parent,root:!1});else if(s===")")this.stack.length>1&&this.stack.pop();else if(s==="{"){const o=r.lastIndex,a=e[o]===" "?o+1:o;e=e.slice(a),this.state=4;continue e}else this.consumeBudget(100),s==="Z0"||s==="0000"||s==="@@@@"?s="--":s.startsWith("0")&&(s=s.replace(/0/g,"O")),i.node&&(i.parent=i.node),i.node=new an({san:s,startingComments:i.startingComments}),i.startingComments=void 0,i.root=!1,i.parent.children.push(i.node)}return}case 4:{const r=e.indexOf("}");if(r===-1){this.commentBuf.push(e);return}else{const n=r>0&&e[r-1]===" "?r-1:r;this.commentBuf.push(e.slice(0,n)),this.handleComment(),e=e.slice(r),this.state=3,t=!1}}}}handleNag(t){var e;this.consumeBudget(50);const r=this.stack[this.stack.length-1];r.node&&((e=r.node.data).nags||(e.nags=[]),r.node.data.nags.push(t))}handleComment(){var t,e;this.consumeBudget(100);const r=this.stack[this.stack.length-1],n=this.commentBuf.join(`
`);this.commentBuf=[],r.node?((t=r.node.data).comments||(t.comments=[]),r.node.data.comments.push(n)):r.root?((e=this.game).comments||(e.comments=[]),this.game.comments.push(n)):(r.startingComments||(r.startingComments=[]),r.startingComments.push(n))}emit(t){if(this.state===4&&this.handleComment(),t)return this.emitGame(this.game,t);this.found&&this.emitGame(this.game,void 0),this.resetGame()}},Cs=(t,e=rr)=>{const r=[];return new ys(n=>r.push(n),e,NaN).parse(t),r},Ss=(t,e)=>{const r=t.ctx(),n=e.match(/^([NBRQK])?([a-h])?([1-8])?[-x]?([a-h][1-8])(?:=?([nbrqkNBRQK]))?[+#]?$/);if(!n){let m;if(e==="O-O"||e==="O-O+"||e==="O-O#"?m="h":(e==="O-O-O"||e==="O-O-O+"||e==="O-O-O#")&&(m="a"),m){const w=t.castles.rook[t.turn][m];return!O(r.king)||!O(w)||!t.dests(r.king,r).has(w)?void 0:{from:r.king,to:w}}const p=e.match(/^([pnbrqkPNBRQK])?@([a-h][1-8])[+#]?$/);if(!p)return;const v={role:p[1]?vt(p[1]):"pawn",to:Er(p[2])};return t.isLegal(v,r)?v:void 0}const i=n[1]?vt(n[1]):"pawn",s=Er(n[4]),o=n[5]?vt(n[5]):void 0;if(!!o!==(i==="pawn"&&h.backranks().has(s))||o==="king"&&t.rules!=="antichess")return;let a=t.board.pieces(t.turn,i);i==="pawn"&&!n[2]?a=a.intersect(h.fromFile(le(s))):n[2]&&(a=a.intersect(h.fromFile(n[2].charCodeAt(0)-97))),n[3]&&(a=a.intersect(h.fromRank(n[3].charCodeAt(0)-49)));const c=i==="pawn"?h.fromFile(le(s)):h.empty();a=a.intersect(c.union(nn({color:T(t.turn),role:i},s,t.board.occupied)));let l;for(const m of a)if(t.dests(m,r).has(s)){if(O(l))return;l=m}if(O(l))return{from:l,to:s,promotion:o}},Es=t=>({trainable:t=="white",id:-1,pos:gs("chess"),clone(){return{...this,pos:this.pos.clone()}}}),xs=t=>({count:t,clone(){return{...this}}}),As=(t,e,r)=>{const n=Es(e);let i=0,s=0;return{moves:bs(t,n,(o,a)=>{const c=Ss(o.pos,a.san);return o.pos.play(c),o.trainable=!o.trainable,o.id++,i++,o.trainable&&s++,{...a,fen:Zi(o.pos.toSetup()),training:{id:i,disabled:o.trainable,seen:!1,group:-1,dueAt:1/0}}}),meta:{trainAs:e,nodeCount:s,bucketEntries:r.map(()=>0)}}};function cn(t,e){ln(t,e)}function ln(t,e){for(const r in e)Object.prototype.hasOwnProperty.call(e,r)&&(Object.prototype.hasOwnProperty.call(t,r)&&$r(t[r])&&$r(e[r])?ln(t[r],e[r]):t[r]=e[r])}function $r(t){if(typeof t!="object"||t===null)return!1;const e=Object.getPrototypeOf(t);return e===Object.prototype||e===null}function Ms(t){return{set(e){cn(t,e)},addSubrepertoires:(e,r)=>{const n=Cs(e);for(const i of n){const s={...i,headers:{...i.headers},...As(i.moves,r,t.buckets)};t.repertoire.push(s)}return!0},update:e=>{let r=e||Math.floor(Date.now()/1e3);return(t.time=r)?!1:(t.time=r,!0)},state:t,setMethod:e=>{t.method=e,t.path=null},next:()=>{if(t.index==-1)return!1;let e=[],r=t.repertoire[t.index];for(const n of r.moves.children)e.push({path:[n],layer:0});for(;e.length!=0;){const n=t.getNext.by=="breadth"?e.shift():e.pop(),i=n.path.at(-1);if(!i.data.training.disabled)switch(t.method){case"recall":if(i.data.training.dueAt<=t.time)return t.path=n.path,!0;break;case"learn":if(!i.data.training.seen)return t.path=n.path,!0;break}if(n.layer<t.getNext.max)for(const s of i.children){const o={path:[...n.path,s],layer:++n.layer};e.push(o)}}return!1},load:e=>{if(e>=t.repertoire.length)throw new Error(`Index ${e} is out of bounds for repertoire of size ${t.repertoire.length}`);t.index=e},path:()=>t.path,guess:e=>{var s,o;const r=t.index;if(r==-1||!t.path||t.method=="learn")return;let n=[];t.path.length==1?t.repertoire[r].moves.children.forEach(a=>n.push(a)):(s=t.path.at(-2))==null||s.children.forEach(a=>n.push(a));let i=[];return i=n.map(a=>a.data.san),i.includes(e)?((o=t.path.at(-1))==null?void 0:o.data.san)===e?"success":"alternate":"failure"},succeed:()=>{var n;const e=(n=t.path)==null?void 0:n.at(-1),r=t.repertoire[t.index];if(e)switch(t.method){case"recall":let i=e.data.training.group;switch(r.meta.bucketEntries[i]--,t.promotion){case"most":i=t.buckets.length-1;break;case"next":i=Math.min(i+1,t.buckets.length-1);break}r.meta.bucketEntries[i]++;const s=t.buckets[i];e.data.training={...e.data.training,group:i,dueAt:t.time+s};break;case"learn":e.data.training={...e.data.training,seen:!0,dueAt:t.time+t.buckets[0],group:0},r.meta.bucketEntries[0]++;break}},fail:()=>{var i;let e=(i=t.path)==null?void 0:i.at(-1);const r=t.repertoire[t.index];if(!e)return;let n=e.data.training.group;switch(r.meta.bucketEntries[n]--,t.method){case"recall":switch(t.demotion){case"most":n=0;break;case"next":n=Math.max(n-1,0);break}r.meta.bucketEntries[n]++;const s=t.buckets[n];e.data.training={...e.data.training,group:n,dueAt:t.time+s}}},countDue:()=>{const r=t.repertoire[t.index].moves,n=xs(0);return ws(r,n,(i,s)=>{i.count+=!s.training.disabled&&s.training.dueAt<t.time?1:0}),n.count},current:()=>t.repertoire[t.index]}}function Rs(){return{method:"learn",getNext:{by:"breadth",max:1/0},buckets:[30,86400,259200,604800,1814400,5443200,16329600,31536e3],promotion:"next",demotion:"next",path:null,repertoire:[],index:-1,time:Math.round(Date.now()/1e3)}}function Ps(t){const e=Rs();return cn(e,t||{}),Ms(e)}const Os=["white","black"],lt=["a","b","c","d","e","f","g","h"],ht=["1","2","3","4","5","6","7","8"],Ns=[...ht].reverse(),nr=Array.prototype.concat(...lt.map(t=>ht.map(e=>t+e))),X=t=>nr[8*t[0]+t[1]],K=t=>[t.charCodeAt(0)-97,t.charCodeAt(1)-49],hn=nr.map(K);function $s(t){let e;const r=()=>(e===void 0&&(e=t()),e);return r.clear=()=>{e=void 0},r}const Ts=()=>{let t;return{start(){t=performance.now()},cancel(){t=void 0},stop(){if(!t)return 0;const e=performance.now()-t;return t=void 0,e}}},ir=t=>t==="white"?"black":"white",Ze=(t,e)=>{const r=t[0]-e[0],n=t[1]-e[1];return r*r+n*n},It=(t,e)=>t.role===e.role&&t.color===e.color,et=t=>(e,r)=>[(r?e[0]:7-e[0])*t.width/8,(r?7-e[1]:e[1])*t.height/8],re=(t,e)=>{t.style.transform=`translate(${e[0]}px,${e[1]}px)`},un=(t,e,r=1)=>{t.style.transform=`translate(${e[0]}px,${e[1]}px) scale(${r})`},sr=(t,e)=>{t.style.visibility=e?"visible":"hidden"},xe=t=>{var e;if(t.clientX||t.clientX===0)return[t.clientX,t.clientY];if(!((e=t.targetTouches)===null||e===void 0)&&e[0])return[t.targetTouches[0].clientX,t.targetTouches[0].clientY]},dn=t=>t.button===2,ce=(t,e)=>{const r=document.createElement(t);return e&&(r.className=e),r};function fn(t,e,r){const n=K(t);return e||(n[0]=7-n[0],n[1]=7-n[1]),[r.left+r.width*n[0]/8+r.width/16,r.top+r.height*(7-n[1])/8+r.height/16]}const We="rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR",Ds={p:"pawn",r:"rook",n:"knight",b:"bishop",q:"queen",k:"king"},Fs={pawn:"p",rook:"r",knight:"n",bishop:"b",queen:"q",king:"k"};function pn(t){t==="start"&&(t=We);const e=new Map;let r=7,n=0;for(const i of t)switch(i){case" ":case"[":return e;case"/":if(--r,r<0)return e;n=0;break;case"~":{const s=e.get(X([n-1,r]));s&&(s.promoted=!0);break}default:{const s=i.charCodeAt(0);if(s<57)n+=s-48;else{const o=i.toLowerCase();e.set(X([n,r]),{role:Ds[o],color:i===o?"black":"white"}),++n}}}return e}function Bs(t){return Ns.map(e=>lt.map(r=>{const n=t.get(r+e);if(n){let i=Fs[n.role];return n.color==="white"&&(i=i.toUpperCase()),n.promoted&&(i+="~"),i}else return"1"}).join("")).join("/").replace(/1{2,}/g,e=>e.length.toString())}const zt=["a","b","c","d","e","f","g","h"],mn=["1","2","3","4","5","6","7","8"],Le=["white","black"],ne=["pawn","knight","bishop","rook","queen","king"],Ls=["a","h"],Ve=t=>"role"in t,x=t=>t!==void 0,H=t=>t==="white"?"black":"white",Se=t=>t>>3,Z=t=>t&7,_t=(t,e)=>0<=t&&t<8&&0<=e&&e<8?t+8*e:void 0,St=t=>{switch(t){case"pawn":return"p";case"knight":return"n";case"bishop":return"b";case"rook":return"r";case"queen":return"q";case"king":return"k"}};function $e(t){switch(t.toLowerCase()){case"p":return"pawn";case"n":return"knight";case"b":return"bishop";case"r":return"rook";case"q":return"queen";case"k":return"king";default:return}}function Te(t){if(t.length===2)return _t(t.charCodeAt(0)-97,t.charCodeAt(1)-49)}const ye=t=>zt[Z(t)]+mn[Se(t)],Ks=t=>{if(t[1]==="@"&&t.length===4){const e=$e(t[0]),r=Te(t.slice(2));if(e&&x(r))return{role:e,to:r}}else if(t.length===4||t.length===5){const e=Te(t.slice(0,2)),r=Te(t.slice(2,4));let n;if(t.length===5&&(n=$e(t[4]),!n))return;if(x(e)&&x(r))return{from:e,to:r,promotion:n}}},or=(t,e)=>t==="white"?e==="a"?2:6:e==="a"?58:62,ar=(t,e)=>t==="white"?e==="a"?3:5:e==="a"?59:61,Tr=t=>(t=t-(t>>>1&1431655765),t=(t&858993459)+(t>>>2&858993459),Math.imul(t+(t>>>4)&252645135,16843009)>>24),qt=t=>(t=t>>>8&16711935|(t&16711935)<<8,t>>>16&65535|(t&65535)<<16),Dr=t=>(t=t>>>1&1431655765|(t&1431655765)<<1,t=t>>>2&858993459|(t&858993459)<<2,t=t>>>4&252645135|(t&252645135)<<4,qt(t));class d{constructor(e,r){this.lo=e|0,this.hi=r|0}static fromSquare(e){return e>=32?new d(0,1<<e-32):new d(1<<e,0)}static fromRank(e){return new d(255,0).shl64(8*e)}static fromFile(e){return new d(16843009<<e,16843009<<e)}static empty(){return new d(0,0)}static full(){return new d(4294967295,4294967295)}static corners(){return new d(129,2164260864)}static center(){return new d(402653184,24)}static backranks(){return new d(255,4278190080)}static backrank(e){return e==="white"?new d(255,0):new d(0,4278190080)}static lightSquares(){return new d(1437226410,1437226410)}static darkSquares(){return new d(2857740885,2857740885)}complement(){return new d(~this.lo,~this.hi)}xor(e){return new d(this.lo^e.lo,this.hi^e.hi)}union(e){return new d(this.lo|e.lo,this.hi|e.hi)}intersect(e){return new d(this.lo&e.lo,this.hi&e.hi)}diff(e){return new d(this.lo&~e.lo,this.hi&~e.hi)}intersects(e){return this.intersect(e).nonEmpty()}isDisjoint(e){return this.intersect(e).isEmpty()}supersetOf(e){return e.diff(this).isEmpty()}subsetOf(e){return this.diff(e).isEmpty()}shr64(e){return e>=64?d.empty():e>=32?new d(this.hi>>>e-32,0):e>0?new d(this.lo>>>e^this.hi<<32-e,this.hi>>>e):this}shl64(e){return e>=64?d.empty():e>=32?new d(0,this.lo<<e-32):e>0?new d(this.lo<<e,this.hi<<e^this.lo>>>32-e):this}bswap64(){return new d(qt(this.hi),qt(this.lo))}rbit64(){return new d(Dr(this.hi),Dr(this.lo))}minus64(e){const r=this.lo-e.lo,n=(r&e.lo&1)+(e.lo>>>1)+(r>>>1)>>>31;return new d(r,this.hi-(e.hi+n))}equals(e){return this.lo===e.lo&&this.hi===e.hi}size(){return Tr(this.lo)+Tr(this.hi)}isEmpty(){return this.lo===0&&this.hi===0}nonEmpty(){return this.lo!==0||this.hi!==0}has(e){return(e>=32?this.hi&1<<e-32:this.lo&1<<e)!==0}set(e,r){return r?this.with(e):this.without(e)}with(e){return e>=32?new d(this.lo,this.hi|1<<e-32):new d(this.lo|1<<e,this.hi)}without(e){return e>=32?new d(this.lo,this.hi&~(1<<e-32)):new d(this.lo&~(1<<e),this.hi)}toggle(e){return e>=32?new d(this.lo,this.hi^1<<e-32):new d(this.lo^1<<e,this.hi)}last(){if(this.hi!==0)return 63-Math.clz32(this.hi);if(this.lo!==0)return 31-Math.clz32(this.lo)}first(){if(this.lo!==0)return 31-Math.clz32(this.lo&-this.lo);if(this.hi!==0)return 63-Math.clz32(this.hi&-this.hi)}withoutFirst(){return this.lo!==0?new d(this.lo&this.lo-1,this.hi):new d(0,this.hi&this.hi-1)}moreThanOne(){return this.hi!==0&&this.lo!==0||(this.lo&this.lo-1)!==0||(this.hi&this.hi-1)!==0}singleSquare(){return this.moreThanOne()?void 0:this.last()}*[Symbol.iterator](){let e=this.lo,r=this.hi;for(;e!==0;){const n=31-Math.clz32(e&-e);e^=1<<n,yield n}for(;r!==0;){const n=31-Math.clz32(r&-r);r^=1<<n,yield 32+n}}*reversed(){let e=this.lo,r=this.hi;for(;r!==0;){const n=31-Math.clz32(r);r^=1<<n,yield 32+n}for(;e!==0;){const n=31-Math.clz32(e);e^=1<<n,yield n}}}const ut=(t,e)=>{let r=d.empty();for(const n of e){const i=t+n;0<=i&&i<64&&Math.abs(Z(t)-Z(i))<=2&&(r=r.with(i))}return r},fe=t=>{const e=[];for(let r=0;r<64;r++)e[r]=t(r);return e},Is=fe(t=>ut(t,[-9,-8,-7,-1,1,7,8,9])),zs=fe(t=>ut(t,[-17,-15,-10,-6,6,10,15,17])),_s={white:fe(t=>ut(t,[7,9])),black:fe(t=>ut(t,[-7,-9]))},gt=t=>Is[t],kt=t=>zs[t],tt=(t,e)=>_s[t][e],jt=fe(t=>d.fromFile(Z(t)).without(t)),Ht=fe(t=>d.fromRank(Se(t)).without(t)),Wt=fe(t=>{const e=new d(134480385,2151686160),r=8*(Se(t)-Z(t));return(r>=0?e.shl64(r):e.shr64(-r)).without(t)}),Gt=fe(t=>{const e=new d(270549120,16909320),r=8*(Se(t)+Z(t)-7);return(r>=0?e.shl64(r):e.shr64(-r)).without(t)}),Ut=(t,e,r)=>{let n=r.intersect(e),i=n.bswap64();return n=n.minus64(t),i=i.minus64(t.bswap64()),n.xor(i.bswap64()).intersect(e)},qs=(t,e)=>Ut(d.fromSquare(t),jt[t],e),js=(t,e)=>{const r=Ht[t];let n=e.intersect(r),i=n.rbit64();return n=n.minus64(d.fromSquare(t)),i=i.minus64(d.fromSquare(63-t)),n.xor(i.rbit64()).intersect(r)},Ke=(t,e)=>{const r=d.fromSquare(t);return Ut(r,Wt[t],e).xor(Ut(r,Gt[t],e))},Ie=(t,e)=>qs(t,e).xor(js(t,e)),cr=(t,e)=>Ke(t,e).xor(Ie(t,e)),Hs=(t,e,r)=>{switch(t.role){case"pawn":return tt(t.color,e);case"knight":return kt(e);case"bishop":return Ke(e,r);case"rook":return Ie(e,r);case"queen":return cr(e,r);case"king":return gt(e)}},gn=(t,e)=>{const r=d.fromSquare(e);return Ht[t].intersects(r)?Ht[t].with(t):Gt[t].intersects(r)?Gt[t].with(t):Wt[t].intersects(r)?Wt[t].with(t):jt[t].intersects(r)?jt[t].with(t):d.empty()},Ye=(t,e)=>gn(t,e).intersect(d.full().shl64(t).xor(d.full().shl64(e))).withoutFirst();class De{constructor(){}static default(){const e=new De;return e.reset(),e}reset(){this.occupied=new d(65535,4294901760),this.promoted=d.empty(),this.white=new d(65535,0),this.black=new d(0,4294901760),this.pawn=new d(65280,16711680),this.knight=new d(66,1107296256),this.bishop=new d(36,603979776),this.rook=new d(129,2164260864),this.queen=new d(8,134217728),this.king=new d(16,268435456)}static empty(){const e=new De;return e.clear(),e}clear(){this.occupied=d.empty(),this.promoted=d.empty();for(const e of Le)this[e]=d.empty();for(const e of ne)this[e]=d.empty()}clone(){const e=new De;e.occupied=this.occupied,e.promoted=this.promoted;for(const r of Le)e[r]=this[r];for(const r of ne)e[r]=this[r];return e}getColor(e){if(this.white.has(e))return"white";if(this.black.has(e))return"black"}getRole(e){for(const r of ne)if(this[r].has(e))return r}get(e){const r=this.getColor(e);if(!r)return;const n=this.getRole(e),i=this.promoted.has(e);return{color:r,role:n,promoted:i}}take(e){const r=this.get(e);return r&&(this.occupied=this.occupied.without(e),this[r.color]=this[r.color].without(e),this[r.role]=this[r.role].without(e),r.promoted&&(this.promoted=this.promoted.without(e))),r}set(e,r){const n=this.take(e);return this.occupied=this.occupied.with(e),this[r.color]=this[r.color].with(e),this[r.role]=this[r.role].with(e),r.promoted&&(this.promoted=this.promoted.with(e)),n}has(e){return this.occupied.has(e)}*[Symbol.iterator](){for(const e of this.occupied)yield[e,this.get(e)]}pieces(e,r){return this[e].intersect(this[r])}rooksAndQueens(){return this.rook.union(this.queen)}bishopsAndQueens(){return this.bishop.union(this.queen)}kingOf(e){return this.pieces(e,"king").singleSquare()}}class ie{constructor(){}static empty(){const e=new ie;for(const r of ne)e[r]=0;return e}static fromBoard(e,r){const n=new ie;for(const i of ne)n[i]=e.pieces(r,i).size();return n}clone(){const e=new ie;for(const r of ne)e[r]=this[r];return e}equals(e){return ne.every(r=>this[r]===e[r])}add(e){const r=new ie;for(const n of ne)r[n]=this[n]+e[n];return r}subtract(e){const r=new ie;for(const n of ne)r[n]=this[n]-e[n];return r}nonEmpty(){return ne.some(e=>this[e]>0)}isEmpty(){return!this.nonEmpty()}hasPawns(){return this.pawn>0}hasNonPawns(){return this.knight>0||this.bishop>0||this.rook>0||this.queen>0||this.king>0}size(){return this.pawn+this.knight+this.bishop+this.rook+this.queen+this.king}}class be{constructor(e,r){this.white=e,this.black=r}static empty(){return new be(ie.empty(),ie.empty())}static fromBoard(e){return new be(ie.fromBoard(e,"white"),ie.fromBoard(e,"black"))}clone(){return new be(this.white.clone(),this.black.clone())}equals(e){return this.white.equals(e.white)&&this.black.equals(e.black)}add(e){return new be(this.white.add(e.white),this.black.add(e.black))}subtract(e){return new be(this.white.subtract(e.white),this.black.subtract(e.black))}count(e){return this.white[e]+this.black[e]}size(){return this.white.size()+this.black.size()}isEmpty(){return this.white.isEmpty()&&this.black.isEmpty()}nonEmpty(){return!this.isEmpty()}hasPawns(){return this.white.hasPawns()||this.black.hasPawns()}hasNonPawns(){return this.white.hasNonPawns()||this.black.hasNonPawns()}}class Xe{constructor(e,r){this.white=e,this.black=r}static default(){return new Xe(3,3)}clone(){return new Xe(this.white,this.black)}equals(e){return this.white===e.white&&this.black===e.black}}class kn{unwrap(e,r){const n=this._chain(i=>M.ok(e?e(i):i),i=>r?M.ok(r(i)):M.err(i));if(n.isErr)throw n.error;return n.value}map(e,r){return this._chain(n=>M.ok(e(n)),n=>M.err(r?r(n):n))}chain(e,r){return this._chain(e,r||(n=>M.err(n)))}}class Ws extends kn{constructor(e){super(),this.value=void 0,this.isOk=!0,this.isErr=!1,this.value=e}_chain(e,r){return e(this.value)}}class Gs extends kn{constructor(e){super(),this.error=void 0,this.isOk=!1,this.isErr=!0,this.error=e}_chain(e,r){return r(this.error)}}var M;(function(t){t.ok=function(e){return new Ws(e)},t.err=function(e){return new Gs(e||new Error)},t.all=function(e){if(Array.isArray(e)){const i=[];for(let s=0;s<e.length;s++){const o=e[s];if(o.isErr)return o;i.push(o.value)}return t.ok(i)}const r={},n=Object.keys(e);for(let i=0;i<n.length;i++){const s=e[n[i]];if(s.isErr)return s;r[n[i]]=s.value}return t.ok(r)}})(M||(M={}));var ue;(function(t){t.Empty="ERR_EMPTY",t.OppositeCheck="ERR_OPPOSITE_CHECK",t.PawnsOnBackrank="ERR_PAWNS_ON_BACKRANK",t.Kings="ERR_KINGS",t.Variant="ERR_VARIANT"})(ue||(ue={}));class Me extends Error{}const Us=(t,e,r,n)=>r[e].intersect(Ie(t,n).intersect(r.rooksAndQueens()).union(Ke(t,n).intersect(r.bishopsAndQueens())).union(kt(t).intersect(r.knight)).union(gt(t).intersect(r.king)).union(tt(H(e),t).intersect(r.pawn)));class we{constructor(){}static default(){const e=new we;return e.castlingRights=d.corners(),e.rook={white:{a:0,h:7},black:{a:56,h:63}},e.path={white:{a:new d(14,0),h:new d(96,0)},black:{a:new d(0,234881024),h:new d(0,1610612736)}},e}static empty(){const e=new we;return e.castlingRights=d.empty(),e.rook={white:{a:void 0,h:void 0},black:{a:void 0,h:void 0}},e.path={white:{a:d.empty(),h:d.empty()},black:{a:d.empty(),h:d.empty()}},e}clone(){const e=new we;return e.castlingRights=this.castlingRights,e.rook={white:{a:this.rook.white.a,h:this.rook.white.h},black:{a:this.rook.black.a,h:this.rook.black.h}},e.path={white:{a:this.path.white.a,h:this.path.white.h},black:{a:this.path.black.a,h:this.path.black.h}},e}add(e,r,n,i){const s=or(e,r),o=ar(e,r);this.castlingRights=this.castlingRights.with(i),this.rook[e][r]=i,this.path[e][r]=Ye(i,o).with(o).union(Ye(n,s).with(s)).without(n).without(i)}static fromSetup(e){const r=we.empty(),n=e.castlingRights.intersect(e.board.rook);for(const i of Le){const s=d.backrank(i),o=e.board.kingOf(i);if(!x(o)||!s.has(o))continue;const a=n.intersect(e.board[i]).intersect(s),c=a.first();x(c)&&c<o&&r.add(i,"a",o,c);const l=a.last();x(l)&&o<l&&r.add(i,"h",o,l)}return r}discardRook(e){if(this.castlingRights.has(e)){this.castlingRights=this.castlingRights.without(e);for(const r of Le)for(const n of Ls)this.rook[r][n]===e&&(this.rook[r][n]=void 0)}}discardColor(e){this.castlingRights=this.castlingRights.diff(d.backrank(e)),this.rook[e].a=void 0,this.rook[e].h=void 0}}class Qs{constructor(e){this.rules=e}reset(){this.board=De.default(),this.pockets=void 0,this.turn="white",this.castles=we.default(),this.epSquare=void 0,this.remainingChecks=void 0,this.halfmoves=0,this.fullmoves=1}setupUnchecked(e){this.board=e.board.clone(),this.board.promoted=d.empty(),this.pockets=void 0,this.turn=e.turn,this.castles=we.fromSetup(e),this.epSquare=Zs(this,e.epSquare),this.remainingChecks=void 0,this.halfmoves=e.halfmoves,this.fullmoves=e.fullmoves}kingAttackers(e,r,n){return Us(e,r,this.board,n)}playCaptureAt(e,r){this.halfmoves=0,r.role==="rook"&&this.castles.discardRook(e),this.pockets&&this.pockets[H(r.color)][r.promoted?"pawn":r.role]++}ctx(){const e=this.isVariantEnd(),r=this.board.kingOf(this.turn);if(!x(r))return{king:r,blockers:d.empty(),checkers:d.empty(),variantEnd:e,mustCapture:!1};const n=Ie(r,d.empty()).intersect(this.board.rooksAndQueens()).union(Ke(r,d.empty()).intersect(this.board.bishopsAndQueens())).intersect(this.board[H(this.turn)]);let i=d.empty();for(const o of n){const a=Ye(r,o).intersect(this.board.occupied);a.moreThanOne()||(i=i.union(a))}const s=this.kingAttackers(r,H(this.turn),this.board.occupied);return{king:r,blockers:i,checkers:s,variantEnd:e,mustCapture:!1}}clone(){var e,r;const n=new this.constructor;return n.board=this.board.clone(),n.pockets=(e=this.pockets)===null||e===void 0?void 0:e.clone(),n.turn=this.turn,n.castles=this.castles.clone(),n.epSquare=this.epSquare,n.remainingChecks=(r=this.remainingChecks)===null||r===void 0?void 0:r.clone(),n.halfmoves=this.halfmoves,n.fullmoves=this.fullmoves,n}validate(){if(this.board.occupied.isEmpty())return M.err(new Me(ue.Empty));if(this.board.king.size()!==2)return M.err(new Me(ue.Kings));if(!x(this.board.kingOf(this.turn)))return M.err(new Me(ue.Kings));const e=this.board.kingOf(H(this.turn));return x(e)?this.kingAttackers(e,this.turn,this.board.occupied).nonEmpty()?M.err(new Me(ue.OppositeCheck)):d.backranks().intersects(this.board.pawn)?M.err(new Me(ue.PawnsOnBackrank)):M.ok(void 0):M.err(new Me(ue.Kings))}dropDests(e){return d.empty()}dests(e,r){if(r=r||this.ctx(),r.variantEnd)return d.empty();const n=this.board.get(e);if(!n||n.color!==this.turn)return d.empty();let i,s;if(n.role==="pawn"){i=tt(this.turn,e).intersect(this.board[H(this.turn)]);const o=this.turn==="white"?8:-8,a=e+o;if(0<=a&&a<64&&!this.board.occupied.has(a)){i=i.with(a);const c=this.turn==="white"?e<16:e>=48,l=a+o;c&&!this.board.occupied.has(l)&&(i=i.with(l))}x(this.epSquare)&&Ys(this,e,r)&&(s=d.fromSquare(this.epSquare))}else n.role==="bishop"?i=Ke(e,this.board.occupied):n.role==="knight"?i=kt(e):n.role==="rook"?i=Ie(e,this.board.occupied):n.role==="queen"?i=cr(e,this.board.occupied):i=gt(e);if(i=i.diff(this.board[this.turn]),x(r.king)){if(n.role==="king"){const o=this.board.occupied.without(e);for(const a of i)this.kingAttackers(a,H(this.turn),o).nonEmpty()&&(i=i.without(a));return i.union(Fr(this,"a",r)).union(Fr(this,"h",r))}if(r.checkers.nonEmpty()){const o=r.checkers.singleSquare();if(!x(o))return d.empty();i=i.intersect(Ye(o,r.king).with(o))}r.blockers.has(e)&&(i=i.intersect(gn(e,r.king)))}return s&&(i=i.union(s)),i}isVariantEnd(){return!1}variantOutcome(e){}hasInsufficientMaterial(e){return this.board[e].intersect(this.board.pawn.union(this.board.rooksAndQueens())).nonEmpty()?!1:this.board[e].intersects(this.board.knight)?this.board[e].size()<=2&&this.board[H(e)].diff(this.board.king).diff(this.board.queen).isEmpty():this.board[e].intersects(this.board.bishop)?(!this.board.bishop.intersects(d.darkSquares())||!this.board.bishop.intersects(d.lightSquares()))&&this.board.pawn.isEmpty()&&this.board.knight.isEmpty():!0}toSetup(){var e,r;return{board:this.board.clone(),pockets:(e=this.pockets)===null||e===void 0?void 0:e.clone(),turn:this.turn,castlingRights:this.castles.castlingRights,epSquare:Vs(this),remainingChecks:(r=this.remainingChecks)===null||r===void 0?void 0:r.clone(),halfmoves:Math.min(this.halfmoves,150),fullmoves:Math.min(Math.max(this.fullmoves,1),9999)}}isInsufficientMaterial(){return Le.every(e=>this.hasInsufficientMaterial(e))}hasDests(e){e=e||this.ctx();for(const r of this.board[this.turn])if(this.dests(r,e).nonEmpty())return!0;return this.dropDests(e).nonEmpty()}isLegal(e,r){if(Ve(e))return!this.pockets||this.pockets[this.turn][e.role]<=0||e.role==="pawn"&&d.backranks().has(e.to)?!1:this.dropDests(r).has(e.to);{if(e.promotion==="pawn"||e.promotion==="king"&&this.rules!=="antichess"||!!e.promotion!==(this.board.pawn.has(e.from)&&d.backranks().has(e.to)))return!1;const n=this.dests(e.from,r);return n.has(e.to)||n.has(Xs(this,e).to)}}isCheck(){const e=this.board.kingOf(this.turn);return x(e)&&this.kingAttackers(e,H(this.turn),this.board.occupied).nonEmpty()}isEnd(e){return(e?e.variantEnd:this.isVariantEnd())?!0:this.isInsufficientMaterial()||!this.hasDests(e)}isCheckmate(e){return e=e||this.ctx(),!e.variantEnd&&e.checkers.nonEmpty()&&!this.hasDests(e)}isStalemate(e){return e=e||this.ctx(),!e.variantEnd&&e.checkers.isEmpty()&&!this.hasDests(e)}outcome(e){const r=this.variantOutcome(e);return r||(e=e||this.ctx(),this.isCheckmate(e)?{winner:H(this.turn)}:this.isInsufficientMaterial()||this.isStalemate(e)?{winner:void 0}:void 0)}allDests(e){e=e||this.ctx();const r=new Map;if(e.variantEnd)return r;for(const n of this.board[this.turn])r.set(n,this.dests(n,e));return r}play(e){const r=this.turn,n=this.epSquare,i=bn(this,e);if(this.epSquare=void 0,this.halfmoves+=1,r==="black"&&(this.fullmoves+=1),this.turn=H(r),Ve(e))this.board.set(e.to,{role:e.role,color:r}),this.pockets&&this.pockets[r][e.role]--,e.role==="pawn"&&(this.halfmoves=0);else{const s=this.board.take(e.from);if(!s)return;let o;if(s.role==="pawn"){this.halfmoves=0,e.to===n&&(o=this.board.take(e.to+(r==="white"?-8:8)));const a=e.from-e.to;Math.abs(a)===16&&8<=e.from&&e.from<=55&&(this.epSquare=e.from+e.to>>1),e.promotion&&(s.role=e.promotion,s.promoted=!!this.pockets)}else if(s.role==="rook")this.castles.discardRook(e.from);else if(s.role==="king"){if(i){const a=this.castles.rook[r][i];if(x(a)){const c=this.board.take(a);this.board.set(or(r,i),s),c&&this.board.set(ar(r,i),c)}}this.castles.discardColor(r)}if(!i){const a=this.board.set(e.to,s)||o;a&&this.playCaptureAt(e.to,a)}}this.remainingChecks&&this.isCheck()&&(this.remainingChecks[r]=Math.max(this.remainingChecks[r]-1,0))}}class lr extends Qs{constructor(){super("chess")}static default(){const e=new this;return e.reset(),e}static fromSetup(e){const r=new this;return r.setupUnchecked(e),r.validate().map(n=>r)}clone(){return super.clone()}}const Zs=(t,e)=>{if(!x(e))return;const r=t.turn==="white"?5:2,n=t.turn==="white"?8:-8;if(Se(e)!==r||t.board.occupied.has(e+n))return;const i=e-n;if(!(!t.board.pawn.has(i)||!t.board[H(t.turn)].has(i)))return e},Vs=t=>{if(!x(t.epSquare))return;const e=t.ctx(),n=t.board.pieces(t.turn,"pawn").intersect(tt(H(t.turn),t.epSquare));for(const i of n)if(t.dests(i,e).has(t.epSquare))return t.epSquare},Ys=(t,e,r)=>{if(!x(t.epSquare)||!tt(t.turn,e).has(t.epSquare))return!1;if(!x(r.king))return!0;const n=t.turn==="white"?8:-8,i=t.epSquare-n;return t.kingAttackers(r.king,H(t.turn),t.board.occupied.toggle(e).toggle(i).with(t.epSquare)).without(i).isEmpty()},Fr=(t,e,r)=>{if(!x(r.king)||r.checkers.nonEmpty())return d.empty();const n=t.castles.rook[t.turn][e];if(!x(n)||t.castles.path[t.turn][e].intersects(t.board.occupied))return d.empty();const i=or(t.turn,e),s=Ye(r.king,i),o=t.board.occupied.without(r.king);for(const l of s)if(t.kingAttackers(l,H(t.turn),o).nonEmpty())return d.empty();const a=ar(t.turn,e),c=t.board.occupied.toggle(r.king).toggle(n).toggle(a);return t.kingAttackers(i,H(t.turn),c).nonEmpty()?d.empty():d.fromSquare(n)},bn=(t,e)=>{if(Ve(e))return;const r=e.to-e.from;if(!(Math.abs(r)!==2&&!t.board[t.turn].has(e.to))&&t.board.king.has(e.from))return r>0?"h":"a"},Xs=(t,e)=>{const r=bn(t,e);if(!r)return e;const n=t.castles.rook[t.turn][r];return{from:e.from,to:x(n)?n:e.to}},Js=(t,e)=>{const r=new Map,n=t.ctx();for(const[i,s]of t.allDests(n))if(s.nonEmpty()){const o=Array.from(s,ye);i===n.king&&Z(i)===4&&(s.has(0)?o.push("c1"):s.has(56)&&o.push("c8"),s.has(7)?o.push("g1"):s.has(63)&&o.push("g8")),r.set(ye(i),o)}return r},eo=t=>Ve(t)?[ye(t.to)]:[ye(t.from),ye(t.to)];var q;(function(t){t.Fen="ERR_FEN",t.Board="ERR_BOARD",t.Pockets="ERR_POCKETS",t.Turn="ERR_TURN",t.Castling="ERR_CASTLING",t.EpSquare="ERR_EP_SQUARE",t.RemainingChecks="ERR_REMAINING_CHECKS",t.Halfmoves="ERR_HALFMOVES",t.Fullmoves="ERR_FULLMOVES"})(q||(q={}));class W extends Error{}const to=(t,e,r)=>{let n=t.indexOf(e);for(;r-- >0&&n!==-1;)n=t.indexOf(e,n+e.length);return n},Ne=t=>/^\d{1,4}$/.test(t)?parseInt(t,10):void 0,wn=t=>{const e=$e(t);return e&&{role:e,color:t.toLowerCase()===t?"black":"white"}},Et=t=>{const e=De.empty();let r=7,n=0;for(let i=0;i<t.length;i++){const s=t[i];if(s==="/"&&n===8)n=0,r--;else{const o=parseInt(s,10);if(o>0)n+=o;else{if(n>=8||r<0)return M.err(new W(q.Board));const a=n+r*8,c=wn(s);if(!c)return M.err(new W(q.Board));t[i+1]==="~"&&(c.promoted=!0,i++),e.set(a,c),n++}}}return r!==0||n!==8?M.err(new W(q.Board)):M.ok(e)},Br=t=>{if(t.length>64)return M.err(new W(q.Pockets));const e=be.empty();for(const r of t){const n=wn(r);if(!n)return M.err(new W(q.Pockets));e[n.color][n.role]++}return M.ok(e)},ro=(t,e)=>{let r=d.empty();if(e==="-")return M.ok(r);for(const n of e){const i=n.toLowerCase(),s=n===i?"black":"white",o=s==="white"?0:7;if("a"<=i&&i<="h")r=r.with(_t(i.charCodeAt(0)-97,o));else if(i==="k"||i==="q"){const a=t[s].intersect(d.backrank(s)).intersect(t.rook.union(t.king)),c=i==="k"?a.last():a.first();r=r.with(x(c)&&t.rook.has(c)?c:_t(i==="k"?7:0,o))}else return M.err(new W(q.Castling))}return Le.some(n=>d.backrank(n).intersect(r).size()>2)?M.err(new W(q.Castling)):M.ok(r)},Lr=t=>{const e=t.split("+");if(e.length===3&&e[0]===""){const r=Ne(e[1]),n=Ne(e[2]);return!x(r)||r>3||!x(n)||n>3?M.err(new W(q.RemainingChecks)):M.ok(new Xe(3-r,3-n))}else if(e.length===2){const r=Ne(e[0]),n=Ne(e[1]);return!x(r)||r>3||!x(n)||n>3?M.err(new W(q.RemainingChecks)):M.ok(new Xe(r,n))}else return M.err(new W(q.RemainingChecks))},hr=t=>{const e=t.split(/[\s_]+/),r=e.shift();let n,i=M.ok(void 0);if(r.endsWith("]")){const a=r.indexOf("[");if(a===-1)return M.err(new W(q.Fen));n=Et(r.slice(0,a)),i=Br(r.slice(a+1,-1))}else{const a=to(r,"/",7);a===-1?n=Et(r):(n=Et(r.slice(0,a)),i=Br(r.slice(a+1)))}let s;const o=e.shift();if(!x(o)||o==="w")s="white";else if(o==="b")s="black";else return M.err(new W(q.Turn));return n.chain(a=>{const c=e.shift(),l=x(c)?ro(a,c):M.ok(d.empty()),m=e.shift();let p;if(x(m)&&m!=="-"&&(p=Te(m),!x(p)))return M.err(new W(q.EpSquare));let v=e.shift(),w;x(v)&&v.includes("+")&&(w=Lr(v),v=e.shift());const u=x(v)?Ne(v):0;if(!x(u))return M.err(new W(q.Halfmoves));const f=e.shift(),k=x(f)?Ne(f):1;if(!x(k))return M.err(new W(q.Fullmoves));const g=e.shift();let y=M.ok(void 0);if(x(g)){if(x(w))return M.err(new W(q.RemainingChecks));y=Lr(g)}else x(w)&&(y=w);return e.length>0?M.err(new W(q.Fen)):i.chain(R=>l.chain(C=>y.map(S=>({board:a,pockets:R,turn:s,castlingRights:C,remainingChecks:S,epSquare:p,halfmoves:u,fullmoves:Math.max(1,k)}))))})},no=(t,e)=>{let r="";if(Ve(e))e.role!=="pawn"&&(r=St(e.role).toUpperCase()),r+="@"+ye(e.to);else{const n=t.board.getRole(e.from);if(!n)return"--";if(n==="king"&&(t.board[t.turn].has(e.to)||Math.abs(e.to-e.from)===2))r=e.to>e.from?"O-O":"O-O-O";else{const i=t.board.occupied.has(e.to)||n==="pawn"&&Z(e.from)!==Z(e.to);if(n!=="pawn"){r=St(n).toUpperCase();let s;if(n==="king"?s=gt(e.to).intersect(t.board.king):n==="queen"?s=cr(e.to,t.board.occupied).intersect(t.board.queen):n==="rook"?s=Ie(e.to,t.board.occupied).intersect(t.board.rook):n==="bishop"?s=Ke(e.to,t.board.occupied).intersect(t.board.bishop):s=kt(e.to).intersect(t.board.knight),s=s.intersect(t.board[t.turn]).without(e.from),s.nonEmpty()){const o=t.ctx();for(const a of s)t.dests(a,o).has(e.to)||(s=s.without(a));if(s.nonEmpty()){let a=!1,c=s.intersects(d.fromRank(Se(e.from)));s.intersects(d.fromFile(Z(e.from)))?a=!0:c=!0,c&&(r+=zt[Z(e.from)]),a&&(r+=mn[Se(e.from)])}}}else i&&(r=zt[Z(e.from)]);i&&(r+="x"),r+=ye(e.to),e.promotion&&(r+="="+St(e.promotion).toUpperCase())}}return r},io=(t,e)=>{var r;const n=no(t,e);return t.play(e),!((r=t.outcome())===null||r===void 0)&&r.winner?n+"#":t.isCheck()?n+"+":n},so=(t,e)=>io(t.clone(),e),oo=(t,e)=>{const r=t.ctx(),n=e.match(/^([NBRQK])?([a-h])?([1-8])?[-x]?([a-h][1-8])(?:=?([nbrqkNBRQK]))?[+#]?$/);if(!n){let m;if(e==="O-O"||e==="O-O+"||e==="O-O#"?m="h":(e==="O-O-O"||e==="O-O-O+"||e==="O-O-O#")&&(m="a"),m){const w=t.castles.rook[t.turn][m];return!x(r.king)||!x(w)||!t.dests(r.king,r).has(w)?void 0:{from:r.king,to:w}}const p=e.match(/^([pnbrqkPNBRQK])?@([a-h][1-8])[+#]?$/);if(!p)return;const v={role:p[1]?$e(p[1]):"pawn",to:Te(p[2])};return t.isLegal(v,r)?v:void 0}const i=n[1]?$e(n[1]):"pawn",s=Te(n[4]),o=n[5]?$e(n[5]):void 0;if(!!o!==(i==="pawn"&&d.backranks().has(s))||o==="king"&&t.rules!=="antichess")return;let a=t.board.pieces(t.turn,i);i==="pawn"&&!n[2]?a=a.intersect(d.fromFile(Z(s))):n[2]&&(a=a.intersect(d.fromFile(n[2].charCodeAt(0)-97))),n[3]&&(a=a.intersect(d.fromRank(n[3].charCodeAt(0)-49)));const c=i==="pawn"?d.fromFile(Z(s)):d.empty();a=a.intersect(c.union(Hs({color:H(t.turn),role:i},s,t.board.occupied)));let l;for(const m of a)if(t.dests(m,r).has(s)){if(x(l))return;l=m}if(x(l))return{from:l,to:s,promotion:o}},ao=t=>t.map(e=>e.data.san),co=t=>Js(lr.fromSetup(hr(t).unwrap()).unwrap()),lo=(t,e)=>{const r=lr.fromSetup(hr(t).unwrap()).unwrap(),n=oo(r,e);return eo(n)},ho=(t,e)=>{const r=new Map;return r.set(t,e),r},uo=(t,e,r)=>{const n=Ks(e+r),i=lr.fromSetup(hr(t).unwrap()).unwrap();return so(i,n)},fo=async()=>{const t="http://localhost:8080/subrepertoires";try{const e=await fetch(t,{headers:{"Content-Type":"application/json"}});if(!e.ok)throw new Error(`Response status: ${e.status}`);return(await e.json()).map(i=>({pgn:i.pgn,trainAs:i.color===1?"black":"white",alias:`part ${i.id}`}))}catch(e){return console.error("Error fetching repertoires:",e),[]}};class po{constructor(e){U(this,"subrepertoireNames",[]);U(this,"chessground");U(this,"chessSrs",Ps({buckets:[1,11,111],getNext:{by:"depth"}}));U(this,"addingNewSubrep",!1);U(this,"toastMessage",null);U(this,"subrep",()=>this.chessSrs.state.repertoire[this.chessSrs.state.index]);U(this,"addSubrepertoire",e=>{this.chessSrs.addSubrepertoires(e.pgn,e.trainAs),this.subrepertoireNames.push(e.alias),this.redraw()});U(this,"selectSubrepertoire",e=>{var r;e!=this.chessSrs.state.index&&(this.chessSrs.load(e),(r=this.chessground)==null||r.set({fen:We}),this.toastMessage=null,console.log("this subrep",this.subrep()),this.redraw())});U(this,"toggleAddingNewSubrep",()=>{this.addingNewSubrep=!this.addingNewSubrep,this.redraw()});U(this,"handleMethodSwitch",()=>{var e;(e=this.chessground)==null||e.setAutoShapes([])});U(this,"handleLearn",()=>{var i,s,o,a,c,l;this.handleMethodSwitch(),this.chessSrs.setMethod("learn"),this.chessSrs.next();const e=((s=(i=this.chessSrs.path())==null?void 0:i.at(-2))==null?void 0:s.data.fen)||We,r=(a=(o=this.chessSrs.path())==null?void 0:o.at(-1))==null?void 0:a.data.san,n=lo(e,r);(c=this.chessground)==null||c.set({turnColor:"white",fen:e,movable:{dests:ho(n[0],n[1]),events:{after:()=>{this.chessSrs.succeed(),this.handleLearn()}}}}),(l=this.chessground)==null||l.setAutoShapes([{orig:n[0],dest:n[1],brush:"green"}]),this.toastMessage={type:"learn",header:"New move",message:"White plays his move."},this.redraw()});U(this,"handleFail",e=>{this.toastMessage={type:"fail",header:"",message:`Incorrect. ${e} is not the right move.`},this.redraw()});U(this,"handleRecall",()=>{var r,n,i,s;this.handleMethodSwitch(),(r=this.chessground)==null||r.setAutoShapes([]),this.chessSrs.setMethod("recall"),this.chessSrs.update(),this.chessSrs.next();const e=((i=(n=this.chessSrs.path())==null?void 0:n.at(-2))==null?void 0:i.data.fen)||We;(s=this.chessground)==null||s.set({turnColor:"white",fen:e,movable:{dests:co(e),events:{after:(o,a)=>{const c=uo(e,o,a);switch(this.chessSrs.guess(c)){case"success":this.chessSrs.succeed(),this.handleRecall();break;case"alternate":this.chessSrs.succeed(),this.handleRecall();break;case"failure":this.handleFail(c);break}}}}}),this.toastMessage={type:"recall",header:"New move",message:"What does White play here?"},this.redraw()});this.redraw=e,document.addEventListener("DOMContentLoaded",async r=>{const n=await fo();console.log(n),n.forEach(i=>this.addSubrepertoire(i))})}}const vn=t=>t&&t!==!0||t==="",Kr=t=>(Array.isArray(t)?t:[t]).filter(vn);function P(t,e,r){return r?E(t,e,Kr(r)):vn(e)?Array.isArray(e)||typeof e=="object"&&"sel"in e?E(t,Kr(e)):E(t,e):E(t)}const Ee=(t,e)=>Math.abs(t-e),mo=t=>(e,r,n,i)=>Ee(e,n)<2&&(t==="white"?i===r+1||r<=1&&i===r+2&&e===n:i===r-1||r>=6&&i===r-2&&e===n),yn=(t,e,r,n)=>{const i=Ee(t,r),s=Ee(e,n);return i===1&&s===2||i===2&&s===1},Cn=(t,e,r,n)=>Ee(t,r)===Ee(e,n),Sn=(t,e,r,n)=>t===r||e===n,En=(t,e,r,n)=>Cn(t,e,r,n)||Sn(t,e,r,n),go=(t,e,r)=>(n,i,s,o)=>Ee(n,s)<2&&Ee(i,o)<2||r&&i===o&&i===(t==="white"?0:7)&&(n===4&&(s===2&&e.includes(0)||s===6&&e.includes(7))||e.includes(s));function ko(t,e){const r=e==="white"?"1":"8",n=[];for(const[i,s]of t)i[1]===r&&s.color===e&&s.role==="rook"&&n.push(K(i)[0]);return n}function xn(t,e,r){const n=t.get(e);if(!n)return[];const i=K(e),s=n.role,o=s==="pawn"?mo(n.color):s==="knight"?yn:s==="bishop"?Cn:s==="rook"?Sn:s==="queen"?En:go(n.color,ko(t,n.color),r);return hn.filter(a=>(i[0]!==a[0]||i[1]!==a[1])&&o(i[0],i[1],a[0],a[1])).map(X)}function V(t,...e){t&&setTimeout(()=>t(...e),1)}function bo(t){t.orientation=ir(t.orientation),t.animation.current=t.draggable.current=t.selected=void 0}function wo(t,e){for(const[r,n]of e)n?t.pieces.set(r,n):t.pieces.delete(r)}function vo(t,e){if(t.check=void 0,e===!0&&(e=t.turnColor),e)for(const[r,n]of t.pieces)n.role==="king"&&n.color===e&&(t.check=r)}function yo(t,e,r,n){ge(t),t.premovable.current=[e,r],V(t.premovable.events.set,e,r,n)}function me(t){t.premovable.current&&(t.premovable.current=void 0,V(t.premovable.events.unset))}function Co(t,e,r){me(t),t.predroppable.current={role:e,key:r},V(t.predroppable.events.set,e,r)}function ge(t){const e=t.predroppable;e.current&&(e.current=void 0,V(e.events.unset))}function So(t,e,r){if(!t.autoCastle)return!1;const n=t.pieces.get(e);if(!n||n.role!=="king")return!1;const i=K(e),s=K(r);if(i[1]!==0&&i[1]!==7||i[1]!==s[1])return!1;i[0]===4&&!t.pieces.has(r)&&(s[0]===6?r=X([7,s[1]]):s[0]===2&&(r=X([0,s[1]])));const o=t.pieces.get(r);return!o||o.color!==n.color||o.role!=="rook"?!1:(t.pieces.delete(e),t.pieces.delete(r),i[0]<s[0]?(t.pieces.set(X([6,s[1]]),n),t.pieces.set(X([5,s[1]]),o)):(t.pieces.set(X([2,s[1]]),n),t.pieces.set(X([3,s[1]]),o)),!0)}function An(t,e,r){const n=t.pieces.get(e),i=t.pieces.get(r);if(e===r||!n)return!1;const s=i&&i.color!==n.color?i:void 0;return r===t.selected&&J(t),V(t.events.move,e,r,s),So(t,e,r)||(t.pieces.set(r,n),t.pieces.delete(e)),t.lastMove=[e,r],t.check=void 0,V(t.events.change),s||!0}function ur(t,e,r,n){if(t.pieces.has(r))if(n)t.pieces.delete(r);else return!1;return V(t.events.dropNewPiece,e,r),t.pieces.set(r,e),t.lastMove=[r],t.check=void 0,V(t.events.change),t.movable.dests=void 0,t.turnColor=ir(t.turnColor),!0}function Mn(t,e,r){const n=An(t,e,r);return n&&(t.movable.dests=void 0,t.turnColor=ir(t.turnColor),t.animation.current=void 0),n}function Rn(t,e,r){if(dr(t,e,r)){const n=Mn(t,e,r);if(n){const i=t.hold.stop();J(t);const s={premove:!1,ctrlKey:t.stats.ctrlKey,holdTime:i};return n!==!0&&(s.captured=n),V(t.movable.events.after,e,r,s),!0}}else if(xo(t,e,r))return yo(t,e,r,{ctrlKey:t.stats.ctrlKey}),J(t),!0;return J(t),!1}function Pn(t,e,r,n){const i=t.pieces.get(e);i&&(Eo(t,e,r)||n)?(t.pieces.delete(e),ur(t,i,r,n),V(t.movable.events.afterNewPiece,i.role,r,{premove:!1,predrop:!1})):i&&Ao(t,e,r)?Co(t,i.role,r):(me(t),ge(t)),t.pieces.delete(e),J(t)}function Qt(t,e,r){if(V(t.events.select,e),t.selected){if(t.selected===e&&!t.draggable.enabled){J(t),t.hold.cancel();return}else if((t.selectable.enabled||r)&&t.selected!==e&&Rn(t,t.selected,e)){t.stats.dragged=!1;return}}(t.selectable.enabled||t.draggable.enabled)&&(Nn(t,e)||fr(t,e))&&(On(t,e),t.hold.start())}function On(t,e){t.selected=e,fr(t,e)?t.premovable.customDests||(t.premovable.dests=xn(t.pieces,e,t.premovable.castle)):t.premovable.dests=void 0}function J(t){t.selected=void 0,t.premovable.dests=void 0,t.hold.cancel()}function Nn(t,e){const r=t.pieces.get(e);return!!r&&(t.movable.color==="both"||t.movable.color===r.color&&t.turnColor===r.color)}const dr=(t,e,r)=>{var n,i;return e!==r&&Nn(t,e)&&(t.movable.free||!!(!((i=(n=t.movable.dests)===null||n===void 0?void 0:n.get(e))===null||i===void 0)&&i.includes(r)))};function Eo(t,e,r){const n=t.pieces.get(e);return!!n&&(e===r||!t.pieces.has(r))&&(t.movable.color==="both"||t.movable.color===n.color&&t.turnColor===n.color)}function fr(t,e){const r=t.pieces.get(e);return!!r&&t.premovable.enabled&&t.movable.color===r.color&&t.turnColor!==r.color}function xo(t,e,r){var n,i;const s=(i=(n=t.premovable.customDests)===null||n===void 0?void 0:n.get(e))!==null&&i!==void 0?i:xn(t.pieces,e,t.premovable.castle);return e!==r&&fr(t,e)&&s.includes(r)}function Ao(t,e,r){const n=t.pieces.get(e),i=t.pieces.get(r);return!!n&&(!i||i.color!==t.movable.color)&&t.predroppable.enabled&&(n.role!=="pawn"||r[1]!=="1"&&r[1]!=="8")&&t.movable.color===n.color&&t.turnColor!==n.color}function Mo(t,e){const r=t.pieces.get(e);return!!r&&t.draggable.enabled&&(t.movable.color==="both"||t.movable.color===r.color&&(t.turnColor===r.color||t.premovable.enabled))}function Ro(t){const e=t.premovable.current;if(!e)return!1;const r=e[0],n=e[1];let i=!1;if(dr(t,r,n)){const s=Mn(t,r,n);if(s){const o={premove:!0};s!==!0&&(o.captured=s),V(t.movable.events.after,r,n,o),i=!0}}return me(t),i}function Po(t,e){const r=t.predroppable.current;let n=!1;if(!r)return!1;if(e(r)){const i={role:r.role,color:t.movable.color};ur(t,i,r.key)&&(V(t.movable.events.afterNewPiece,r.role,r.key,{premove:!1,predrop:!0}),n=!0)}return ge(t),n}function pr(t){me(t),ge(t),J(t)}function Ir(t){t.movable.color=t.movable.dests=t.animation.current=void 0,pr(t)}function Ae(t,e,r){let n=Math.floor(8*(t[0]-r.left)/r.width);e||(n=7-n);let i=7-Math.floor(8*(t[1]-r.top)/r.height);return e||(i=7-i),n>=0&&n<8&&i>=0&&i<8?X([n,i]):void 0}function Oo(t,e,r,n){const i=K(t),s=hn.filter(l=>En(i[0],i[1],l[0],l[1])||yn(i[0],i[1],l[0],l[1])),a=s.map(l=>fn(X(l),r,n)).map(l=>Ze(e,l)),[,c]=a.reduce((l,m,p)=>l[0]<m?l:[m,p],[a[0],0]);return X(s[c])}const Y=t=>t.orientation==="white";function $n(t,e){e.animation&&(mr(t.animation,e.animation),(t.animation.duration||0)<70&&(t.animation.enabled=!1))}function Tn(t,e){var r,n,i;if(!((r=e.movable)===null||r===void 0)&&r.dests&&(t.movable.dests=void 0),!((n=e.drawable)===null||n===void 0)&&n.autoShapes&&(t.drawable.autoShapes=[]),mr(t,e),e.fen&&(t.pieces=pn(e.fen),t.drawable.shapes=((i=e.drawable)===null||i===void 0?void 0:i.shapes)||[]),"check"in e&&vo(t,e.check||!1),"lastMove"in e&&!e.lastMove?t.lastMove=void 0:e.lastMove&&(t.lastMove=e.lastMove),t.selected&&On(t,t.selected),$n(t,e),!t.movable.rookCastle&&t.movable.dests){const s=t.movable.color==="white"?"1":"8",o="e"+s,a=t.movable.dests.get(o),c=t.pieces.get(o);if(!a||!c||c.role!=="king")return;t.movable.dests.set(o,a.filter(l=>!(l==="a"+s&&a.includes("c"+s))&&!(l==="h"+s&&a.includes("g"+s))))}}function mr(t,e){for(const r in e)Object.prototype.hasOwnProperty.call(e,r)&&(Object.prototype.hasOwnProperty.call(t,r)&&zr(t[r])&&zr(e[r])?mr(t[r],e[r]):t[r]=e[r])}function zr(t){if(typeof t!="object"||t===null)return!1;const e=Object.getPrototypeOf(t);return e===Object.prototype||e===null}const ke=(t,e)=>e.animation.enabled?To(t,e):he(t,e);function he(t,e){const r=t(e);return e.dom.redraw(),r}const xt=(t,e)=>({key:t,pos:K(t),piece:e}),No=(t,e)=>e.sort((r,n)=>Ze(t.pos,r.pos)-Ze(t.pos,n.pos))[0];function $o(t,e){const r=new Map,n=[],i=new Map,s=[],o=[],a=new Map;let c,l,m;for(const[p,v]of t)a.set(p,xt(p,v));for(const p of nr)c=e.pieces.get(p),l=a.get(p),c?l?It(c,l.piece)||(s.push(l),o.push(xt(p,c))):o.push(xt(p,c)):l&&s.push(l);for(const p of o)l=No(p,s.filter(v=>It(p.piece,v.piece))),l&&(m=[l.pos[0]-p.pos[0],l.pos[1]-p.pos[1]],r.set(p.key,m.concat(m)),n.push(l.key));for(const p of s)n.includes(p.key)||i.set(p.key,p.piece);return{anims:r,fadings:i}}function Dn(t,e){const r=t.animation.current;if(r===void 0){t.dom.destroyed||t.dom.redrawNow();return}const n=1-(e-r.start)*r.frequency;if(n<=0)t.animation.current=void 0,t.dom.redrawNow();else{const i=Do(n);for(const s of r.plan.anims.values())s[2]=s[0]*i,s[3]=s[1]*i;t.dom.redrawNow(!0),requestAnimationFrame((s=performance.now())=>Dn(t,s))}}function To(t,e){const r=new Map(e.pieces),n=t(e),i=$o(r,e);if(i.anims.size||i.fadings.size){const s=e.animation.current&&e.animation.current.start;e.animation.current={start:performance.now(),frequency:1/e.animation.duration,plan:i},s||Dn(e,performance.now())}else e.dom.redraw();return n}const Do=t=>t<.5?4*t*t*t:(t-1)*(2*t-2)*(2*t-2)+1,Fo=["green","red","blue","yellow"];function Bo(t,e){if(e.touches&&e.touches.length>1)return;e.stopPropagation(),e.preventDefault(),e.ctrlKey?J(t):pr(t);const r=xe(e),n=Ae(r,Y(t),t.dom.bounds());n&&(t.drawable.current={orig:n,pos:r,brush:zo(e),snapToValidMove:t.drawable.defaultSnapToValidMove},Fn(t))}function Fn(t){requestAnimationFrame(()=>{const e=t.drawable.current;if(e){const r=Ae(e.pos,Y(t),t.dom.bounds());r||(e.snapToValidMove=!1);const n=e.snapToValidMove?Oo(e.orig,e.pos,Y(t),t.dom.bounds()):r;n!==e.mouseSq&&(e.mouseSq=n,e.dest=n!==e.orig?n:void 0,t.dom.redrawNow()),Fn(t)}})}function Lo(t,e){t.drawable.current&&(t.drawable.current.pos=xe(e))}function Ko(t){const e=t.drawable.current;e&&(e.mouseSq&&_o(t.drawable,e),Bn(t))}function Bn(t){t.drawable.current&&(t.drawable.current=void 0,t.dom.redraw())}function Io(t){t.drawable.shapes.length&&(t.drawable.shapes=[],t.dom.redraw(),Ln(t.drawable))}function zo(t){var e;const r=(t.shiftKey||t.ctrlKey)&&dn(t),n=t.altKey||t.metaKey||((e=t.getModifierState)===null||e===void 0?void 0:e.call(t,"AltGraph"));return Fo[(r?1:0)+(n?2:0)]}function _o(t,e){const r=i=>i.orig===e.orig&&i.dest===e.dest,n=t.shapes.find(r);n&&(t.shapes=t.shapes.filter(i=>!r(i))),(!n||n.brush!==e.brush)&&t.shapes.push({orig:e.orig,dest:e.dest,brush:e.brush}),Ln(t)}function Ln(t){t.onChange&&t.onChange(t.shapes)}function qo(t,e){if(!(t.trustAllEvents||e.isTrusted)||e.buttons!==void 0&&e.buttons>1||e.touches&&e.touches.length>1)return;const r=t.dom.bounds(),n=xe(e),i=Ae(n,Y(t),r);if(!i)return;const s=t.pieces.get(i),o=t.selected;if(!o&&t.drawable.enabled&&(t.drawable.eraseOnClick||!s||s.color!==t.turnColor)&&Io(t),e.cancelable!==!1&&(!e.touches||t.blockTouchScroll||s||o||jo(t,n)))e.preventDefault();else if(e.touches)return;const a=!!t.premovable.current,c=!!t.predroppable.current;t.stats.ctrlKey=e.ctrlKey,t.selected&&dr(t,t.selected,i)?ke(p=>Qt(p,i),t):Qt(t,i);const l=t.selected===i,m=In(t,i);if(s&&m&&l&&Mo(t,i)){t.draggable.current={orig:i,piece:s,origPos:n,pos:n,started:t.draggable.autoDistance&&t.stats.dragged,element:m,previouslySelected:o,originTarget:e.target,keyHasChanged:!1},m.cgDragging=!0,m.classList.add("dragging");const p=t.dom.elements.ghost;p&&(p.className=`ghost ${s.color} ${s.role}`,re(p,et(r)(K(i),Y(t))),sr(p,!0)),gr(t)}else a&&me(t),c&&ge(t);t.dom.redraw()}function jo(t,e){const r=Y(t),n=t.dom.bounds(),i=Math.pow(n.width/8,2);for(const s of t.pieces.keys()){const o=fn(s,r,n);if(Ze(o,e)<=i)return!0}return!1}function Ho(t,e,r,n){const i="a0";t.pieces.set(i,e),t.dom.redraw();const s=xe(r);t.draggable.current={orig:i,piece:e,origPos:s,pos:s,started:!0,element:()=>In(t,i),originTarget:r.target,newPiece:!0,force:!!n,keyHasChanged:!1},gr(t)}function gr(t){requestAnimationFrame(()=>{var e;const r=t.draggable.current;if(!r)return;!((e=t.animation.current)===null||e===void 0)&&e.plan.anims.has(r.orig)&&(t.animation.current=void 0);const n=t.pieces.get(r.orig);if(!n||!It(n,r.piece))dt(t);else if(!r.started&&Ze(r.pos,r.origPos)>=Math.pow(t.draggable.distance,2)&&(r.started=!0),r.started){if(typeof r.element=="function"){const s=r.element();if(!s)return;s.cgDragging=!0,s.classList.add("dragging"),r.element=s}const i=t.dom.bounds();re(r.element,[r.pos[0]-i.left-i.width/16,r.pos[1]-i.top-i.height/16]),r.keyHasChanged||(r.keyHasChanged=r.orig!==Ae(r.pos,Y(t),i))}gr(t)})}function Wo(t,e){t.draggable.current&&(!e.touches||e.touches.length<2)&&(t.draggable.current.pos=xe(e))}function Go(t,e){const r=t.draggable.current;if(!r)return;if(e.type==="touchend"&&e.cancelable!==!1&&e.preventDefault(),e.type==="touchend"&&r.originTarget!==e.target&&!r.newPiece){t.draggable.current=void 0;return}me(t),ge(t);const n=xe(e)||r.pos,i=Ae(n,Y(t),t.dom.bounds());i&&r.started&&r.orig!==i?r.newPiece?Pn(t,r.orig,i,r.force):(t.stats.ctrlKey=e.ctrlKey,Rn(t,r.orig,i)&&(t.stats.dragged=!0)):r.newPiece?t.pieces.delete(r.orig):t.draggable.deleteOnDropOff&&!i&&(t.pieces.delete(r.orig),V(t.events.change)),(r.orig===r.previouslySelected||r.keyHasChanged)&&(r.orig===i||!i)?J(t):t.selectable.enabled||J(t),Kn(t),t.draggable.current=void 0,t.dom.redraw()}function dt(t){const e=t.draggable.current;e&&(e.newPiece&&t.pieces.delete(e.orig),t.draggable.current=void 0,J(t),Kn(t),t.dom.redraw())}function Kn(t){const e=t.dom.elements;e.ghost&&sr(e.ghost,!1)}function In(t,e){let r=t.dom.elements.board.firstChild;for(;r;){if(r.cgKey===e&&r.tagName==="PIECE")return r;r=r.nextSibling}}function Uo(t,e){t.exploding={stage:1,keys:e},t.dom.redraw(),setTimeout(()=>{_r(t,2),setTimeout(()=>_r(t,void 0),120)},120)}function _r(t,e){t.exploding&&(e?t.exploding.stage=e:t.exploding=void 0,t.dom.redraw())}function Qo(t,e){function r(){bo(t),e()}return{set(n){n.orientation&&n.orientation!==t.orientation&&r(),$n(t,n),(n.fen?ke:he)(i=>Tn(i,n),t)},state:t,getFen:()=>Bs(t.pieces),toggleOrientation:r,setPieces(n){ke(i=>wo(i,n),t)},selectSquare(n,i){n?ke(s=>Qt(s,n,i),t):t.selected&&(J(t),t.dom.redraw())},move(n,i){ke(s=>An(s,n,i),t)},newPiece(n,i){ke(s=>ur(s,n,i),t)},playPremove(){if(t.premovable.current){if(ke(Ro,t))return!0;t.dom.redraw()}return!1},playPredrop(n){if(t.predroppable.current){const i=Po(t,n);return t.dom.redraw(),i}return!1},cancelPremove(){he(me,t)},cancelPredrop(){he(ge,t)},cancelMove(){he(n=>{pr(n),dt(n)},t)},stop(){he(n=>{Ir(n),dt(n)},t)},explode(n){Uo(t,n)},setAutoShapes(n){he(i=>i.drawable.autoShapes=n,t)},setShapes(n){he(i=>i.drawable.shapes=n,t)},getKeyAtDomPos(n){return Ae(n,Y(t),t.dom.bounds())},redrawAll:e,dragNewPiece(n,i,s){Ho(t,n,i,s)},destroy(){Ir(t),t.dom.unbind&&t.dom.unbind(),t.dom.destroyed=!0}}}function Zo(){return{pieces:pn(We),orientation:"white",turnColor:"white",coordinates:!0,coordinatesOnSquares:!1,ranksPosition:"right",autoCastle:!0,viewOnly:!1,disableContextMenu:!1,addPieceZIndex:!1,blockTouchScroll:!1,pieceKey:!1,trustAllEvents:!1,highlight:{lastMove:!0,check:!0},animation:{enabled:!0,duration:200},movable:{free:!0,color:"both",showDests:!0,events:{},rookCastle:!0},premovable:{enabled:!0,showDests:!0,castle:!0,events:{}},predroppable:{enabled:!1,events:{}},draggable:{enabled:!0,distance:3,autoDistance:!0,showGhost:!0,deleteOnDropOff:!1},dropmode:{active:!1},selectable:{enabled:!0},stats:{dragged:!("ontouchstart"in window)},events:{},drawable:{enabled:!0,visible:!0,defaultSnapToValidMove:!0,eraseOnClick:!0,shapes:[],autoShapes:[],brushes:{green:{key:"g",color:"#15781B",opacity:1,lineWidth:10},red:{key:"r",color:"#882020",opacity:1,lineWidth:10},blue:{key:"b",color:"#003088",opacity:1,lineWidth:10},yellow:{key:"y",color:"#e68f00",opacity:1,lineWidth:10},paleBlue:{key:"pb",color:"#003088",opacity:.4,lineWidth:15},paleGreen:{key:"pg",color:"#15781B",opacity:.4,lineWidth:15},paleRed:{key:"pr",color:"#882020",opacity:.4,lineWidth:15},paleGrey:{key:"pgr",color:"#4a4a4a",opacity:.35,lineWidth:15},purple:{key:"purple",color:"#68217a",opacity:.65,lineWidth:10},pink:{key:"pink",color:"#ee2080",opacity:.5,lineWidth:10},white:{key:"white",color:"white",opacity:1,lineWidth:10}},prevSvgHash:""},hold:Ts()}}const qr={hilitePrimary:{key:"hilitePrimary",color:"#3291ff",opacity:1,lineWidth:1},hiliteWhite:{key:"hiliteWhite",color:"#ffffff",opacity:1,lineWidth:1}};function Vo(){const t=j("defs"),e=G(j("filter"),{id:"cg-filter-blur"});return e.appendChild(G(j("feGaussianBlur"),{stdDeviation:"0.019"})),t.appendChild(e),t}function Yo(t,e,r){var n;const i=t.drawable,s=i.current,o=s&&s.mouseSq?s:void 0,a=new Map,c=t.dom.bounds(),l=i.autoShapes.filter(w=>!w.piece);for(const w of i.shapes.concat(l).concat(o?[o]:[])){if(!w.dest)continue;const u=(n=a.get(w.dest))!==null&&n!==void 0?n:new Set,f=mt(pt(K(w.orig),t.orientation),c),k=mt(pt(K(w.dest),t.orientation),c);u.add(Vt(f,k)),a.set(w.dest,u)}const m=i.shapes.concat(l).map(w=>({shape:w,current:!1,hash:jr(w,Zt(w.dest,a),!1,c)}));o&&m.push({shape:o,current:!0,hash:jr(o,Zt(o.dest,a),!0,c)});const p=m.map(w=>w.hash).join(";");if(p===t.drawable.prevSvgHash)return;t.drawable.prevSvgHash=p;const v=e.querySelector("defs");Xo(i,m,v),Jo(m,e.querySelector("g"),r.querySelector("g"),w=>ra(t,w,i.brushes,a,c))}function Xo(t,e,r){var n;const i=new Map;let s;for(const c of e.filter(l=>l.shape.dest&&l.shape.brush))s=zn(t.brushes[c.shape.brush],c.shape.modifiers),!((n=c.shape.modifiers)===null||n===void 0)&&n.hilite&&i.set(ft(s).key,ft(s)),i.set(s.key,s);const o=new Set;let a=r.firstElementChild;for(;a;)o.add(a.getAttribute("cgKey")),a=a.nextElementSibling;for(const[c,l]of i.entries())o.has(c)||r.appendChild(sa(l))}function Jo(t,e,r,n){const i=new Map;for(const s of t)i.set(s.hash,!1);for(const s of[e,r]){const o=[];let a=s.firstElementChild,c;for(;a;)c=a.getAttribute("cgHash"),i.has(c)?i.set(c,!0):o.push(a),a=a.nextElementSibling;for(const l of o)s.removeChild(l)}for(const s of t.filter(o=>!i.get(o.hash)))for(const o of n(s))o.isCustom?r.appendChild(o.el):e.appendChild(o.el)}function jr({orig:t,dest:e,brush:r,piece:n,modifiers:i,customSvg:s,label:o},a,c,l){var m,p;return[l.width,l.height,c,t,e,r,a&&"-",n&&ea(n),i&&ta(i),s&&`custom-${Hr(s.html)},${(p=(m=s.center)===null||m===void 0?void 0:m[0])!==null&&p!==void 0?p:"o"}`,o&&`label-${Hr(o.text)}`].filter(v=>v).join(",")}function ea(t){return[t.color,t.role,t.scale].filter(e=>e).join(",")}function ta(t){return[t.lineWidth,t.hilite&&"*"].filter(e=>e).join(",")}function Hr(t){let e=0;for(let r=0;r<t.length;r++)e=(e<<5)-e+t.charCodeAt(r)>>>0;return e.toString()}function ra(t,{shape:e,current:r,hash:n},i,s,o){var a,c;const l=mt(pt(K(e.orig),t.orientation),o),m=e.dest?mt(pt(K(e.dest),t.orientation),o):l,p=e.brush&&zn(i[e.brush],e.modifiers),v=s.get(e.dest),w=[];if(p){const u=G(j("g"),{cgHash:n});w.push({el:u}),l[0]!==m[0]||l[1]!==m[1]?u.appendChild(ia(e,p,l,m,r,Zt(e.dest,s))):u.appendChild(na(i[e.brush],l,r,o))}if(e.label){const u=e.label;(a=u.fill)!==null&&a!==void 0||(u.fill=e.brush&&i[e.brush].color);const f=e.brush?void 0:"tr";w.push({el:oa(u,n,l,m,v,f),isCustom:!0})}if(e.customSvg){const u=(c=e.customSvg.center)!==null&&c!==void 0?c:"orig",[f,k]=u==="label"?qn(l,m,v).map(y=>y-.5):u==="dest"?m:l,g=G(j("g"),{transform:`translate(${f},${k})`,cgHash:n});g.innerHTML=`<svg width="1" height="1" viewBox="0 0 100 100">${e.customSvg.html}</svg>`,w.push({el:g,isCustom:!0})}return w}function na(t,e,r,n){const i=aa(),s=(n.width+n.height)/(4*Math.max(n.width,n.height));return G(j("circle"),{stroke:t.color,"stroke-width":i[r?0:1],fill:"none",opacity:_n(t,r),cx:e[0],cy:e[1],r:s-i[1]/2})}function ft(t){return["#ffffff","#fff","white"].includes(t.color)?qr.hilitePrimary:qr.hiliteWhite}function ia(t,e,r,n,i,s){var o;function a(m){var p;const v=la(s&&!i),w=n[0]-r[0],u=n[1]-r[1],f=Math.atan2(u,w),k=Math.cos(f)*v,g=Math.sin(f)*v;return G(j("line"),{stroke:m?ft(e).color:e.color,"stroke-width":ca(e,i)+(m?.04:0),"stroke-linecap":"round","marker-end":`url(#arrowhead-${m?ft(e).key:e.key})`,opacity:!((p=t.modifiers)===null||p===void 0)&&p.hilite?1:_n(e,i),x1:r[0],y1:r[1],x2:n[0]-k,y2:n[1]-g})}if(!(!((o=t.modifiers)===null||o===void 0)&&o.hilite))return a(!1);const c=j("g"),l=G(j("g"),{filter:"url(#cg-filter-blur)"});return l.appendChild(ha(r,n)),l.appendChild(a(!0)),c.appendChild(l),c.appendChild(a(!1)),c}function sa(t){const e=G(j("marker"),{id:"arrowhead-"+t.key,orient:"auto",overflow:"visible",markerWidth:4,markerHeight:4,refX:t.key.startsWith("hilite")?1.86:2.05,refY:2});return e.appendChild(G(j("path"),{d:"M0,0 V4 L3,2 Z",fill:t.color})),e.setAttribute("cgKey",t.key),e}function oa(t,e,r,n,i,s){var o;const c=.4*.75**t.text.length,l=qn(r,n,i),m=s==="tr"?.4:0,p=G(j("g"),{transform:`translate(${l[0]+m},${l[1]-m})`,cgHash:e});p.appendChild(G(j("circle"),{r:.4/2,"fill-opacity":s?1:.8,"stroke-opacity":s?1:.7,"stroke-width":.03,fill:(o=t.fill)!==null&&o!==void 0?o:"#666",stroke:"white"}));const v=G(j("text"),{"font-size":c,"font-family":"Noto Sans","text-anchor":"middle",fill:"white",y:.13*.75**t.text.length});return v.innerHTML=t.text,p.appendChild(v),p}function pt(t,e){return e==="white"?t:[7-t[0],7-t[1]]}function Zt(t,e){return(t&&e.has(t)&&e.get(t).size>1)===!0}function j(t){return document.createElementNS("http://www.w3.org/2000/svg",t)}function G(t,e){for(const r in e)Object.prototype.hasOwnProperty.call(e,r)&&t.setAttribute(r,e[r]);return t}function zn(t,e){return e?{color:t.color,opacity:Math.round(t.opacity*10)/10,lineWidth:Math.round(e.lineWidth||t.lineWidth),key:[t.key,e.lineWidth].filter(r=>r).join("")}:t}function aa(){return[3/64,4/64]}function ca(t,e){return(t.lineWidth||10)*(e?.85:1)/64}function _n(t,e){return(t.opacity||1)*(e?.9:1)}function la(t){return(t?20:10)/64}function mt(t,e){const r=Math.min(1,e.width/e.height),n=Math.min(1,e.height/e.width);return[(t[0]-3.5)*r,(3.5-t[1])*n]}function ha(t,e){const r={from:[Math.floor(Math.min(t[0],e[0])),Math.floor(Math.min(t[1],e[1]))],to:[Math.ceil(Math.max(t[0],e[0])),Math.ceil(Math.max(t[1],e[1]))]};return G(j("rect"),{x:r.from[0],y:r.from[1],width:r.to[0]-r.from[0],height:r.to[1]-r.from[1],fill:"none",stroke:"none"})}function Vt(t,e,r=!0){const n=Math.atan2(e[1]-t[1],e[0]-t[0])+Math.PI;return r?(Math.round(n*8/Math.PI)+16)%16:n}function ua(t,e){return Math.sqrt([t[0]-e[0],t[1]-e[1]].reduce((r,n)=>r+n*n,0))}function qn(t,e,r){let n=ua(t,e);const i=Vt(t,e,!1);if(r&&(n-=33/64,r.size>1)){n-=10/64;const s=Vt(t,e);(r.has((s+1)%16)||r.has((s+15)%16))&&s&1&&(n-=.4)}return[t[0]-Math.cos(i)*n,t[1]-Math.sin(i)*n].map(s=>s+.5)}function da(t,e){t.innerHTML="",t.classList.add("cg-wrap");for(const c of Os)t.classList.toggle("orientation-"+c,e.orientation===c);t.classList.toggle("manipulable",!e.viewOnly);const r=ce("cg-container");t.appendChild(r);const n=ce("cg-board");r.appendChild(n);let i,s,o;if(e.drawable.visible&&(i=G(j("svg"),{class:"cg-shapes",viewBox:"-4 -4 8 8",preserveAspectRatio:"xMidYMid slice"}),i.appendChild(Vo()),i.appendChild(j("g")),s=G(j("svg"),{class:"cg-custom-svgs",viewBox:"-3.5 -3.5 8 8",preserveAspectRatio:"xMidYMid slice"}),s.appendChild(j("g")),o=ce("cg-auto-pieces"),r.appendChild(i),r.appendChild(s),r.appendChild(o)),e.coordinates){const c=e.orientation==="black"?" black":"",l=e.ranksPosition==="left"?" left":"";if(e.coordinatesOnSquares){const m=e.orientation==="white"?p=>p+1:p=>8-p;lt.forEach((p,v)=>r.appendChild(At(ht.map(w=>p+w),"squares rank"+m(v)+c+l)))}else r.appendChild(At(ht,"ranks"+c+l)),r.appendChild(At(lt,"files"+c))}let a;return e.draggable.enabled&&e.draggable.showGhost&&(a=ce("piece","ghost"),sr(a,!1),r.appendChild(a)),{board:n,container:r,wrap:t,ghost:a,svg:i,customSvg:s,autoPieces:o}}function At(t,e){const r=ce("coords",e);let n;for(const i of t)n=ce("coord"),n.textContent=i,r.appendChild(n);return r}function fa(t,e){if(!t.dropmode.active)return;me(t),ge(t);const r=t.dropmode.piece;if(r){t.pieces.set("a0",r);const n=xe(e),i=n&&Ae(n,Y(t),t.dom.bounds());i&&Pn(t,"a0",i)}t.dom.redraw()}function pa(t,e){const r=t.dom.elements.board;if("ResizeObserver"in window&&new ResizeObserver(e).observe(t.dom.elements.wrap),(t.disableContextMenu||t.drawable.enabled)&&r.addEventListener("contextmenu",i=>i.preventDefault()),t.viewOnly)return;const n=ga(t);r.addEventListener("touchstart",n,{passive:!1}),r.addEventListener("mousedown",n,{passive:!1})}function ma(t,e){const r=[];if("ResizeObserver"in window||r.push(qe(document.body,"chessground.resize",e)),!t.viewOnly){const n=Wr(t,Wo,Lo),i=Wr(t,Go,Ko);for(const o of["touchmove","mousemove"])r.push(qe(document,o,n));for(const o of["touchend","mouseup"])r.push(qe(document,o,i));const s=()=>t.dom.bounds.clear();r.push(qe(document,"scroll",s,{capture:!0,passive:!0})),r.push(qe(window,"resize",s,{passive:!0}))}return()=>r.forEach(n=>n())}function qe(t,e,r,n){return t.addEventListener(e,r,n),()=>t.removeEventListener(e,r,n)}const ga=t=>e=>{t.draggable.current?dt(t):t.drawable.current?Bn(t):e.shiftKey||dn(e)?t.drawable.enabled&&Bo(t,e):t.viewOnly||(t.dropmode.active?fa(t,e):qo(t,e))},Wr=(t,e,r)=>n=>{t.drawable.current?t.drawable.enabled&&r(t,n):t.viewOnly||e(t,n)};function ka(t){const e=Y(t),r=et(t.dom.bounds()),n=t.dom.elements.board,i=t.pieces,s=t.animation.current,o=s?s.plan.anims:new Map,a=s?s.plan.fadings:new Map,c=t.draggable.current,l=wa(t),m=new Set,p=new Set,v=new Map,w=new Map;let u,f,k,g,y,R,C,S,A,$;for(f=n.firstChild;f;){if(u=f.cgKey,jn(f))if(k=i.get(u),y=o.get(u),R=a.get(u),g=f.cgPiece,f.cgDragging&&(!c||c.orig!==u)&&(f.classList.remove("dragging"),re(f,r(K(u),e)),f.cgDragging=!1),!R&&f.cgFading&&(f.cgFading=!1,f.classList.remove("fading")),k){if(y&&f.cgAnimating&&g===je(k)){const b=K(u);b[0]+=y[2],b[1]+=y[3],f.classList.add("anim"),re(f,r(b,e))}else f.cgAnimating&&(f.cgAnimating=!1,f.classList.remove("anim"),re(f,r(K(u),e)),t.addPieceZIndex&&(f.style.zIndex=Mt(K(u),e)));g===je(k)&&(!R||!f.cgFading)?m.add(u):R&&g===je(R)?(f.classList.add("fading"),f.cgFading=!0):Rt(v,g,f)}else Rt(v,g,f);else if(Hn(f)){const b=f.className;l.get(u)===b?p.add(u):Rt(w,b,f)}f=f.nextSibling}for(const[b,F]of l)if(!p.has(b)){A=w.get(F),$=A&&A.pop();const L=r(K(b),e);if($)$.cgKey=b,re($,L);else{const B=ce("square",F);B.cgKey=b,re(B,L),n.insertBefore(B,n.firstChild)}}for(const[b,F]of i)if(y=o.get(b),!m.has(b))if(C=v.get(je(F)),S=C&&C.pop(),S){S.cgKey=b,S.cgFading&&(S.classList.remove("fading"),S.cgFading=!1);const L=K(b);t.addPieceZIndex&&(S.style.zIndex=Mt(L,e)),y&&(S.cgAnimating=!0,S.classList.add("anim"),L[0]+=y[2],L[1]+=y[3]),re(S,r(L,e))}else{const L=je(F),B=ce("piece",L),_=K(b);B.cgPiece=L,B.cgKey=b,y&&(B.cgAnimating=!0,_[0]+=y[2],_[1]+=y[3]),re(B,r(_,e)),t.addPieceZIndex&&(B.style.zIndex=Mt(_,e)),n.appendChild(B)}for(const b of v.values())Ur(t,b);for(const b of w.values())Ur(t,b)}function ba(t){const e=Y(t),r=et(t.dom.bounds());let n=t.dom.elements.board.firstChild;for(;n;)(jn(n)&&!n.cgAnimating||Hn(n))&&re(n,r(K(n.cgKey),e)),n=n.nextSibling}function Gr(t){var e,r;const n=t.dom.elements.wrap.getBoundingClientRect(),i=t.dom.elements.container,s=n.height/n.width,o=Math.floor(n.width*window.devicePixelRatio/8)*8/window.devicePixelRatio,a=o*s;i.style.width=o+"px",i.style.height=a+"px",t.dom.bounds.clear(),(e=t.addDimensionsCssVarsTo)===null||e===void 0||e.style.setProperty("---cg-width",o+"px"),(r=t.addDimensionsCssVarsTo)===null||r===void 0||r.style.setProperty("---cg-height",a+"px")}const jn=t=>t.tagName==="PIECE",Hn=t=>t.tagName==="SQUARE";function Ur(t,e){for(const r of e)t.dom.elements.board.removeChild(r)}function Mt(t,e){const n=t[1];return`${e?10-n:3+n}`}const je=t=>`${t.color} ${t.role}`;function wa(t){var e,r,n;const i=new Map;if(t.lastMove&&t.highlight.lastMove)for(const a of t.lastMove)oe(i,a,"last-move");if(t.check&&t.highlight.check&&oe(i,t.check,"check"),t.selected&&(oe(i,t.selected,"selected"),t.movable.showDests)){const a=(e=t.movable.dests)===null||e===void 0?void 0:e.get(t.selected);if(a)for(const l of a)oe(i,l,"move-dest"+(t.pieces.has(l)?" oc":""));const c=(n=(r=t.premovable.customDests)===null||r===void 0?void 0:r.get(t.selected))!==null&&n!==void 0?n:t.premovable.dests;if(c)for(const l of c)oe(i,l,"premove-dest"+(t.pieces.has(l)?" oc":""))}const s=t.premovable.current;if(s)for(const a of s)oe(i,a,"current-premove");else t.predroppable.current&&oe(i,t.predroppable.current.key,"current-premove");const o=t.exploding;if(o)for(const a of o.keys)oe(i,a,"exploding"+o.stage);return t.highlight.custom&&t.highlight.custom.forEach((a,c)=>{oe(i,c,a)}),i}function oe(t,e,r){const n=t.get(e);n?t.set(e,`${n} ${r}`):t.set(e,r)}function Rt(t,e,r){const n=t.get(e);n?n.push(r):t.set(e,[r])}function va(t,e,r){const n=new Map,i=[];for(const a of t)n.set(a.hash,!1);let s=e.firstElementChild,o;for(;s;)o=s.getAttribute("cgHash"),n.has(o)?n.set(o,!0):i.push(s),s=s.nextElementSibling;for(const a of i)e.removeChild(a);for(const a of t)n.get(a.hash)||e.appendChild(r(a))}function ya(t,e){const n=t.drawable.autoShapes.filter(i=>i.piece).map(i=>({shape:i,hash:Ea(i),current:!1}));va(n,e,i=>Sa(t,i,t.dom.bounds()))}function Ca(t){var e;const r=Y(t),n=et(t.dom.bounds());let i=(e=t.dom.elements.autoPieces)===null||e===void 0?void 0:e.firstChild;for(;i;)un(i,n(K(i.cgKey),r),i.cgScale),i=i.nextSibling}function Sa(t,{shape:e,hash:r},n){var i,s,o;const a=e.orig,c=(i=e.piece)===null||i===void 0?void 0:i.role,l=(s=e.piece)===null||s===void 0?void 0:s.color,m=(o=e.piece)===null||o===void 0?void 0:o.scale,p=ce("piece",`${c} ${l}`);return p.setAttribute("cgHash",r),p.cgKey=a,p.cgScale=m,un(p,et(n)(K(a),Y(t)),m),p}const Ea=t=>{var e,r,n;return[t.orig,(e=t.piece)===null||e===void 0?void 0:e.role,(r=t.piece)===null||r===void 0?void 0:r.color,(n=t.piece)===null||n===void 0?void 0:n.scale].join(",")};function xa(t,e){const r=Zo();Tn(r,e||{});function n(){const i="dom"in r?r.dom.unbind:void 0,s=da(t,r),o=$s(()=>s.board.getBoundingClientRect()),a=m=>{ka(l),s.autoPieces&&ya(l,s.autoPieces),!m&&s.svg&&Yo(l,s.svg,s.customSvg)},c=()=>{Gr(l),ba(l),s.autoPieces&&Ca(l)},l=r;return l.dom={elements:s,bounds:o,redraw:Aa(a),redrawNow:a,unbind:i},l.drawable.prevSvgHash="",Gr(l),a(!1),pa(l,c),i||(l.dom.unbind=ma(l,c)),l.events.insert&&l.events.insert(s),l}return Qo(n(),n)}function Aa(t){let e=!1;return()=>{e||(e=!0,requestAnimationFrame(()=>{t(),e=!1}))}}function Ma(t){return console.log(t),{coordinates:!0,movable:{color:"white",free:!1}}}const Ra=t=>E("section.blue.merida.m-4.shadow.appearance-none.border.rounded",[E("div.cg-wrap",{hook:{insert:e=>{const r=e.elm;t.chessground=xa(r,Ma(t))}}})]),Wn=()=>E("svg",{attrs:{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",width:15,height:15,color:"#000000",fill:"none"}},[E("path",{attrs:{d:"M15.5 12C15.5 13.933 13.933 15.5 12 15.5C10.067 15.5 8.5 13.933 8.5 12C8.5 10.067 10.067 8.5 12 8.5C13.933 8.5 15.5 10.067 15.5 12Z",stroke:"currentColor",strokeWidth:"1.5"}}),E("path",{attrs:{d:"M21.011 14.0965C21.5329 13.9558 21.7939 13.8854 21.8969 13.7508C22 13.6163 22 13.3998 22 12.9669V11.0332C22 10.6003 22 10.3838 21.8969 10.2493C21.7938 10.1147 21.5329 10.0443 21.011 9.90358C19.0606 9.37759 17.8399 7.33851 18.3433 5.40087C18.4817 4.86799 18.5509 4.60156 18.4848 4.44529C18.4187 4.28902 18.2291 4.18134 17.8497 3.96596L16.125 2.98673C15.7528 2.77539 15.5667 2.66972 15.3997 2.69222C15.2326 2.71472 15.0442 2.90273 14.6672 3.27873C13.208 4.73448 10.7936 4.73442 9.33434 3.27864C8.95743 2.90263 8.76898 2.71463 8.60193 2.69212C8.43489 2.66962 8.24877 2.77529 7.87653 2.98663L6.15184 3.96587C5.77253 4.18123 5.58287 4.28891 5.51678 4.44515C5.45068 4.6014 5.51987 4.86787 5.65825 5.4008C6.16137 7.3385 4.93972 9.37763 2.98902 9.9036C2.46712 10.0443 2.20617 10.1147 2.10308 10.2492C2 10.3838 2 10.6003 2 11.0332V12.9669C2 13.3998 2 13.6163 2.10308 13.7508C2.20615 13.8854 2.46711 13.9558 2.98902 14.0965C4.9394 14.6225 6.16008 16.6616 5.65672 18.5992C5.51829 19.1321 5.44907 19.3985 5.51516 19.5548C5.58126 19.7111 5.77092 19.8188 6.15025 20.0341L7.87495 21.0134C8.24721 21.2247 8.43334 21.3304 8.6004 21.3079C8.76746 21.2854 8.95588 21.0973 9.33271 20.7213C10.7927 19.2644 13.2088 19.2643 14.6689 20.7212C15.0457 21.0973 15.2341 21.2853 15.4012 21.3078C15.5682 21.3303 15.7544 21.2246 16.1266 21.0133L17.8513 20.034C18.2307 19.8187 18.4204 19.711 18.4864 19.5547C18.5525 19.3984 18.4833 19.132 18.3448 18.5991C17.8412 16.6616 19.0609 14.6226 21.011 14.0965Z",stroke:"currentColor",strokeWidth:"1.5",strokeLinecap:"round"}})]),Pa=()=>E("svg",{attrs:{xmlns:"http://www.w3.org/2000/svg",viewbox:"0 0 24 24",width:"24",height:"24",color:"#000000",fill:"none"}},[E("path",{attrs:{d:"M2.5 12C2.5 7.52166 2.5 5.28249 3.89124 3.89124C5.28249 2.5 7.52166 2.5 12 2.5C16.4783 2.5 18.7175 2.5 20.1088 3.89124C21.5 5.28249 21.5 7.52166 21.5 12C21.5 16.4783 21.5 18.7175 20.1088 20.1088C18.7175 21.5 16.4783 21.5 12 21.5C7.52166 21.5 5.28249 21.5 3.89124 20.1088C2.5 18.7175 2.5 16.4783 2.5 12Z",stroke:"currentColor","stroke-width":"1.5","stroke-linejoin":"round"}}),E("path",{attrs:{d:"M12 8V16M16 12H8",stroke:"currentColor","stroke-width":"1.5","stroke-linecap":"round","stroke-linejoin":"round"}})]),Oa=()=>E("svg",{attrs:{xmlns:"http://www.w3.org/2000/svg",viewbox:"0 0 24 24",width:"24",height:"24",color:"#000000",fill:"none"}},[E("path",{attrs:{d:"M19.0005 4.99988L5.00045 18.9999M5.00045 4.99988L19.0005 18.9999",stroke:"currentColor","stroke-width":"1.5","stroke-linecap":"round","stroke-linejoin":"round"}})]),Na=t=>E("index.bg-gray-200",`${t+1}.`),$a=t=>E("move.flex-1",t),Ta=t=>E("div#move-row.flex.gap-1",t),Da=t=>{let e=[];t.chessSrs.state.path!=null&&(e=ao(t.chessSrs.state.path));const r=[];let n=[],i=0;for(;e.length>0;)i%2==0&&n.push(Na(i/2)),n.push($a(e.shift())),i++,i%2==0&&(r.push(Ta(n)),n=[]);return E("div#pgn-tree.w-1/5.h-1/2.shadow.appearance-none.border.rounded.flex.flex-col",[E("div.text-center.flex.items-center.justify-around.bg-gray-200",[E("h3.font-light.flex-1","PGN tree"),Wn()]),E("div.flex-1.overflow-y-scroll",r),E("div#pgn-control.bg-gray-200.mt-auto.flex.justify-center.gap-1",[])])},Fa=t=>E("svg",{attrs:{xmlns:"http://www.w3.org/2000/svg",viewbox:"0 0 24 24",width:"24",height:"24",color:t.chessSrs.state.method=="recall"?"#FFFF20":"#FFFFFF",fill:"none"}},[E("path",{attrs:{d:"M20.5 5.5H9.5C5.78672 5.5 3 8.18503 3 12",stroke:"currentColor","stroke-width":"1.5","stroke-linecap":"round","stroke-linejoin":"round"}}),E("path",{attrs:{d:"M3.5 18.5H14.5C18.2133 18.5 21 15.815 21 12",stroke:"currentColor","stroke-width":"1.5","stroke-linecap":"round","stroke-linejoin":"round"}}),E("path",{attrs:{d:"M18.5 3C18.5 3 21 4.84122 21 5.50002C21 6.15882 18.5 8 18.5 8",stroke:"currentColor","stroke-width":"1.5","stroke-linecap":"round","stroke-linejoin":"round"}}),E("path",{attrs:{d:"M5.49998 16C5.49998 16 3.00001 17.8412 3 18.5C2.99999 19.1588 5.5 21 5.5 21",stroke:"currentColor","stroke-width":"1.5","stroke-linecap":"round","stroke-linejoin":"round"}})]),Ba=t=>E("svg",{attrs:{xmlns:"http://www.w3.org/2000/svg",viewbox:"0 0 24 24",width:"24",height:"24",color:t.chessSrs.state.method=="learn"?"#FFFF20":"#FFFFFF",fill:"none"}},[E("path",{attrs:{d:"M6.08938 14.999C5.71097 14.1484 5.5 13.2021 5.5 12.2049C5.5 8.50135 8.41015 5.49902 12 5.49902C15.5899 5.49902 18.5 8.50135 18.5 12.2049C18.5 13.2021 18.289 14.1484 17.9106 14.999",stroke:"currentColor","stroke-width":"1.5","stroke-linecap":"round"}}),E("path",{attrs:{d:"M12 1.99902V2.99902",stroke:"currentColor","stroke-width":"1.5","stroke-linecap":"round","stroke-linejoin":"round"}}),E("path",{attrs:{d:"M22 11.999H21",stroke:"currentColor","stroke-width":"1.5","stroke-linecap":"round","stroke-linejoin":"round"}}),E("path",{attrs:{d:"M3 11.999H2",stroke:"currentColor","stroke-width":"1.5","stroke-linecap":"round","stroke-linejoin":"round"}}),E("path",{attrs:{d:"M19.0704 4.92773L18.3633 5.63484",stroke:"currentColor","stroke-width":"1.5","stroke-linecap":"round","stroke-linejoin":"round"}}),E("path",{attrs:{d:"M5.6368 5.63582L4.92969 4.92871",stroke:"currentColor","stroke-width":"1.5","stroke-linecap":"round","stroke-linejoin":"round"}}),E("path",{attrs:{d:"M14.517 19.3055C15.5274 18.9786 15.9326 18.0538 16.0466 17.1236C16.0806 16.8458 15.852 16.6152 15.572 16.6152L8.47685 16.6154C8.18725 16.6155 7.95467 16.8612 7.98925 17.1488C8.1009 18.0771 8.3827 18.7553 9.45345 19.3055M14.517 19.3055C14.517 19.3055 9.62971 19.3055 9.45345 19.3055M14.517 19.3055C14.3955 21.2505 13.8338 22.0207 12.0068 21.9991C10.0526 22.0352 9.60303 21.0831 9.45345 19.3055",stroke:"currentColor","stroke-width":"1.5","stroke-linecap":"round","stroke-linejoin":"round"}})]),La=()=>E("svg",{class:{"fill-current":!0,"text-white":!0},attrs:{xmlns:"http://www.w3.org/2000/svg",viewbox:"0 0 16 16",width:"20",height:"20"}},[E("path",{attrs:{"fill-rule":"evenodd",d:"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z"}})]),Ka=()=>E("svg",{attrs:{xmlns:"http://www.w3.org/2000/svg",viewbox:"0 0 24 24",width:"24",height:"24",color:"#FFFFFF",fill:"none"}},[E("circle",{attrs:{cx:"12",cy:"12",r:"10",stroke:"currentColor","stroke-width":"1.5"}}),E("path",{attrs:{d:"M10 9C10 7.89543 10.8954 7 12 7C13.1046 7 14 7.89543 14 9C14 9.39815 13.8837 9.76913 13.6831 10.0808C13.0854 11.0097 12 11.8954 12 13V13.5",stroke:"currentColor","stroke-width":"1.5","stroke-linecap":"round"}}),E("path",{attrs:{d:"M11.992 17H12.001",stroke:"currentColor","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round"}})]),Ia=t=>(console.log(t),E("svg",{attrs:{viewbox:"0 0 24 24",fill:"none",width:"24",height:"24",color:"#FFFFFF",xmlns:"http://www.w3.org/2000/svg"}},[E("path",{attrs:{d:"M16 8L8 16M8.00001 8L16 16M21 12C21 16.9706 16.9706 21 12 21C7.02944 21 3 16.9706 3 12C3 7.02944 7.02944 3 12 3C16.9706 3 21 7.02944 21 12Z",stroke:"#FFFFFF","stroke-width":"1.5","stroke-linecap":"round","stroke-linejoin":"round"}})])),Qr=t=>{var e;return(e=document.getElementById(t))==null?void 0:e.value},za=t=>{var e;return(e=document.getElementById(t))==null?void 0:e.checked},_a=t=>P("div#mode-wrap.flex.items-end.gap-1.justify-center.p-1.h-14",[P("button.text-white.font-bold.py-1.px-4.border-blue-700.hover:border-blue-500.rounded.border-b-4.hover:bg-blue-400.flex.active:transform.active:translate-y-px.active:border-b",{on:{click:()=>t.handleLearn()},class:{"bg-blue-500":t.chessSrs.state.method=="recall","bg-blue-400":t.chessSrs.state.method=="learn","border-blue-700":t.chessSrs.state.method=="recall","border-blue-500":t.chessSrs.state.method=="learn","translate-y-px":t.chessSrs.state.method=="learn","border-b":t.chessSrs.state.method=="learn"}},[P("span","LEARN"),Ba(t)]),P("button.text-white.font-bold.py-1.px-4.border-orange-700.hover:border-orange-500.rounded.border-b-4.hover:bg-orange-400.flex.active:transform.active:translate-y-px.active:border-b",{on:{click:()=>t.handleRecall()},class:{"bg-orange-500":t.chessSrs.state.method=="learn","bg-orange-400":t.chessSrs.state.method=="recall","border-orange-700":t.chessSrs.state.method=="learn","border-orange-500":t.chessSrs.state.method=="recall","translate-y-px":t.chessSrs.state.method=="recall","border-b":t.chessSrs.state.method=="recall"}},[P("span","RECALL"),Fa(t)])]),qa=t=>P("button.flex.m-auto",{on:{click:()=>t.toggleAddingNewSubrep()}},Pa()),ja=t=>{const e=t.subrepertoireNames.length;return P("div#subrepertoire-tree-wrap.w-64.flex-row",[e==0?P("div.mx-5.border-b-2.border-cyan-400","Nothing to see"):e==1?P("div.mx-5.border-b-2.border-cyan-400","1 Entry"):P("span.mx-5.border-b-2.border-cyan-400.m-auto",`${e} entries`),...t.subrepertoireNames.map((r,n)=>P("div.subrepertoire.flex.items-center.justify-around.hover:bg-cyan-100",{on:{click:()=>t.selectSubrepertoire(n)},class:{"bg-cyan-100":t.chessSrs.state.index==n}},[P("span.font-medium.text-cyan-400.pr-3",(n+1).toString()),P("h3.font-light.flex-1",r),Wn()]))])},Ha=t=>P("dialog.fixed.top-1/2.left-1/2.transform.-translate-x-1/2.-translate-y-1/2.z-50.border-none",{attrs:{open:!0}},[P("button.bg-red-500.rounded-full.h-6.w-6.flex.items-center.justify-center.absolute.top-1.right-1",{on:{click:()=>t.toggleAddingNewSubrep()}},Oa()),P("form.p-8.bg-white.rounded-md.shadow-md",{on:{submit:e=>{e.preventDefault(),t.addSubrepertoire({alias:Qr("name"),pgn:Qr("pgn"),trainAs:za("color")?"black":"white"}),t.toggleAddingNewSubrep()}}},[P("div.mb-2",[P("label.block.text-gray-700.text-sm.font-bold.mb-2","Name"),P("input#name.shadow.appearance-none.border.rounded.w-full.py-2.px-3.text-gray-700.mb-3.leading-tight.focus:outline-none.focus:shadow-outline")]),P("div.mb-3",[P("label.block.text-gray-700.text-sm.font-bold.mb-2","PGN"),P("textarea#pgn.shadow.block.w-full.text-sm.text-gray-700.rounded-lg.border.border-gray-300.p-3",{attrs:{rows:"4",placeholder:`Enter PGN...
ex. 1. d4 d5 2. c4 c6`}})]),P("div.mb-5",[P("label.block.text-gray-700.text-sm.font-bold.mb-2","Train As"),P("label.inline-flex.items-center.rounded-md.cursor-pointer.text-gray-100",{attrs:{for:"color"}},[P("input#color.hidden.peer",{attrs:{type:"checkbox"}}),P("span.px-4.rounded-l-md.bg-gray-700.peer-checked:bg-gray-300","White"),P("span.px-4.rounded-r-md.bg-gray-300.peer-checked:bg-gray-700","Black")])]),P("button.bg-blue-500.hover:bg-blue-700.text-white.font-bold.py-2.px-4.rounded.focus:outline-none.focus:shadow-outline",{attrs:{type:"submit"}},"Add")])]),Wa=t=>{const e=r=>{switch(r){case"fail":return Ia(t);case"learn":return La();case"recall":return Ka()}};return t.toastMessage&&P("div.p-1",[P("div.w-50.shadow-lg.rounded-lg.flex",[P("div.bg-blue-500.py-3.px-3.rounded-l-lg.flex.items-center",{class:{"bg-blue-500":t.toastMessage.type==="learn","bg-orange-500":t.toastMessage.type==="recall","bg-red-500":t.toastMessage.type==="fail"}},e(t.toastMessage.type)),P("div.px-4.py-2.bg-white.rounded-r-lg.flex.justify-between.items-center.w-full.border.border-l.transparent.border-gray-200",[P("div.font-light.text-sm",t.toastMessage.message)])])])},Gn=t=>P("div#root.flex.justify-center.gap-5.bg-neutral-100.h-full.items-start",[P("div#reperoire-wrap.bg-white.rounded-lg.block-inline",[ja(t),qa(t)]),P("div#main-wrap",[_a(t),Ra(t),Wa(t)]),Da(t),t.addingNewSubrep&&Ha(t)]),Un=vi([Oi,Ni,Ai,Mi,Li]),Qn=new po(Ga),Zn=document.querySelector("body");Zn.innerHTML="";const Vn=document.createElement("div");Zn.appendChild(Vn);let Zr=Un(Vn,Gn(Qn));function Ga(){Zr=Un(Zr,Gn(Qn))}
